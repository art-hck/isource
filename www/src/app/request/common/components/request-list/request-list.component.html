<!-- tabs -->
<div class="app-row">
  <div class="app-col">

    <div class="alert alert-app-level alert-info ng-star-inserted" *ngIf="!hideNeedUpdate">
      <div class="alert-items">
        <div class="alert-item">
          <span class="alert-text">Список заявок был изменен</span>
          <div class="alert-actions">
            <button uxgButton outline class="alert-action" (click)="hideNeedUpdate = true; refresh.emit()">Обновить список</button>
          </div>
        </div>
      </div>
      <button type="button" class="close" (click)="hideNeedUpdate = true"><uxg-icon shape="app-cross"></uxg-icon></button>
    </div>

    <div class="app-row app-align-items-center">
      <uxg-tabs class="app-col">
        <uxg-tab-title #inProgressTab [active]="true"
                       (click)="switchTab(inProgressTab, [RequestStatus.IN_PROGRESS])"
                       [disabled]="statusCounters?.inProgressRequestsCount === 0">
          В обработке <span class="app-ghost-color">({{statusCounters?.inProgressRequestsCount}})</span>
        </uxg-tab-title>

        <uxg-tab-title #newTab
                       (click)="switchTab(newTab, [RequestStatus.NEW])"
                       [disabled]="statusCounters?.newRequestsCount === 0">
          Новые <span class="app-ghost-color">({{statusCounters?.newRequestsCount}})</span>
        </uxg-tab-title>

        <uxg-tab-title #draftTab
                       (click)="switchTab(draftTab, [RequestStatus.DRAFT])"
                       *ngIf="feature.authorize('publishRequest')"
                       [disabled]="statusCounters?.draftRequestsCount === 0">
          Черновики <span class="app-ghost-color">({{statusCounters?.draftRequestsCount}})</span>
        </uxg-tab-title>

        <uxg-tab-title #onApprovalTab
                       (click)="switchTab(onApprovalTab, [RequestStatus.ON_CUSTOMER_APPROVAL])"
                       [disabled]="statusCounters?.onCustomerApprovalRequestsCount === 0">
          На согласовании <span class="app-ghost-color">({{statusCounters?.onCustomerApprovalRequestsCount}})</span>
        </uxg-tab-title>

        <uxg-tab-title #completedTab
                       (click)="switchTab(completedTab, [RequestStatus.COMPLETED, RequestStatus.NOT_RELEVANT])"
                       [disabled]="statusCounters?.completedRequestsCount === 0">
          Завершенные <span class="app-ghost-color">({{statusCounters?.completedRequestsCount}})</span>
        </uxg-tab-title>
      </uxg-tabs>

      <button uxgButton secondary iconText *ngIf="feature.authorize('createRequest')" (click)="addRequest.emit()">
        <uxg-icon shape="app-plus"></uxg-icon>
        <span>Новая заявка</span>
      </button>
      <button uxgButton secondary iconText class="filter-button" (click)="filterOpened = true">
        <uxg-icon shape="app-sort2"></uxg-icon>
        <span>Фильтр</span>
        <span *ngIf="activeFilters?.length > 0" class="counter-bubble">{{ activeFilters.length }}</span>
      </button>
    </div>
  </div>
  <div class="app-col-aside"></div>
</div>


<!-- headers -->
<div class="app-row">
  <div class="app-col">
    <div class="app-table app-no-border">
      <div class="app-row app-uppercase app-ghost-color app-bold">
        <small class="app-col sorter app-grow-0 number"
               [class.active-sort]="sortingColumn === 'number'"
               [ngClass]="{'asc' : sortDirection === 'ASC', 'desc' : sortDirection === 'DESC'}"
               (click)="sortBy('number')">
          <span>Номер</span>
          <uxg-icon shape="app-sort-arrows"></uxg-icon>
        </small>

        <small class="app-col sorter app-grow-0 published"
               [class.active-sort]="sortingColumn === 'published'"
               [ngClass]="{'asc' : sortDirection === 'ASC', 'desc' : sortDirection === 'DESC'}"
               (click)="sortBy('published')">
          <span>Опублик.</span>
          <uxg-icon shape="app-sort-arrows"></uxg-icon>
        </small>

        <small *ngIf="feature.authorize('backofficeRequest')" class="app-col customer">Заказчик</small>

        <!--        <small *ngIf="newTab.active" class="app-col published">Опубликована</small>-->
        <!--        <small *ngIf="completedTab.active" class="app-col completed">Завершена</small>-->

        <small class="app-col sorter name"
               [class.active-sort]="sortingColumn === 'name'"
               [ngClass]="{'asc' : sortDirection === 'ASC', 'desc' : sortDirection === 'DESC'}"
               (click)="sortBy('name')">
          <span>Наименование</span>
          <uxg-icon shape="app-sort-arrows"></uxg-icon>
        </small>

        <small class="app-col delivery-date">Сроки поставки</small>

        <small *ngIf="inProgressTab.active && feature.authorize('backofficeRequest')" class="app-col app-grow-0 tasks">Задач</small>

        <small *ngIf="inProgressTab.active"
               class="app-col sorter app-grow-0 pie"
               [class.active-sort]="sortingColumn === 'finishedPositions'"
               [ngClass]="{'asc' : sortDirection === 'ASC', 'desc' : sortDirection === 'DESC'}"
               (click)="sortBy('finishedPositions')">
          <span>Завершено поз.</span>
          <uxg-icon shape="app-sort-arrows"></uxg-icon>
        </small>

        <small *ngIf="!inProgressTab.active"
               class="app-col sorter app-grow-0 positions"
               [class.active-sort]="sortingColumn === 'positions'"
               [ngClass]="{'asc' : sortDirection === 'ASC', 'desc' : sortDirection === 'DESC'}"
               (click)="sortBy('positions')">
          <span>Позиций</span>
          <uxg-icon shape="app-sort-arrows"></uxg-icon>
        </small>

      </div>
    </div>
  </div>
  <div class="app-col-aside filter" [class.opened]="filterOpened">
  </div>
</div>

<!-- requests -->
<div class="app-row">
  <div class="backdrop" (click)="filterOpened = false" [class.opened]="filterOpened"></div>
  <div class="app-col">
    <div class="app-table" [class.disabled]="status !== 'received'">
      <a class="app-row app-link-no-color" [routerLink]="request.request.id" *ngFor="let request of requests">
        <div class="app-col app-grow-0 number app-bold">{{ request.request.number | number:'1.0-2' }}</div>

        <div class="app-col app-grow-0 published app-ghost-color">
          {{ request.request.publishedDate | date:'dd.MM.yyyy' }}
        </div>

        <div *ngIf="feature.authorize('backofficeRequest')"
             title="{{ request.request.contragent?.shortName }}"
             class="app-col customer app-ellipsis">
          {{ request.request.contragent?.shortName }}
        </div>

        <!--        <div *ngIf="newTab.active" class="app-col published"></div>-->
        <!--        <div *ngIf="completedTab.active" class="app-col completed">Завершена</div>-->

        <div class="app-col name app-ellipsis">{{ request.request.name }}</div>

        <div class="app-col delivery-date app-ellipsis">
          <ng-container *ngIf="request.requestData.positionsCount === 0; else deliveryDates">
            <span>—</span>
          </ng-container>

          <ng-template #deliveryDates>
            <ng-container *ngIf="request.requestData.asapDeliveryDatePositionsCount !== request.requestData.positionsCount; else allPositionsAsap">
              <span *ngIf="request.requestData.minDeliveryDate"
                    title="{{ getDeliveryDate(
                            (request.requestData.minDeliveryDate | date:'dd.MM.yyyy'),
                            (request.requestData.maxDeliveryDate | date:'dd.MM.yyyy') ) }}">
                {{ getDeliveryDate(
                  (request.requestData.minDeliveryDate | date:'dd.MM.yyyy'),
                  (request.requestData.maxDeliveryDate | date:'dd.MM.yyyy')
                ) }}
              </span>

              <span *ngIf="request.requestData.minDeliveryDate && request.requestData.asapDeliveryDatePositionsCount"
                    title="Как можно быстрее: {{ request.requestData.asapDeliveryDatePositionsCount }} поз.">
               Как можно быстрее: {{ request.requestData.asapDeliveryDatePositionsCount }} поз.
              </span>
            </ng-container>

            <ng-template #allPositionsAsap>
              <span>Все как можно быстрее</span>
            </ng-template>
          </ng-template>

        </div>

        <div *ngIf="inProgressTab.active && feature.authorize('backofficeRequest')" class="app-col app-grow-0 tasks">{{request.requestData.tasksCount}}</div>

        <div *ngIf="inProgressTab.active" class="app-col app-grow-0 app-row pie">
          <svg width="20" height="20" class="chart">
            <circle r="10" cx="10" cy="10" class="pie"/>
            <circle r="10" cx="10" cy="10" class="pie" [attr.stroke-dashoffset]="calcPieChart(request)"/>
          </svg>
          <div>
            <span [class.app-ghost-color]="request.requestData.completedPositionsCount === 0">
              {{ request.requestData.completedPositionsCount}} из
            </span>
            <span>{{ request.requestData.positionsCount }}</span>
          </div>
        </div>

        <div *ngIf="!inProgressTab.active" class="app-col app-grow-0 positions">{{ request.requestData.positionsCount}}</div>
      </a>
    </div>
    <br/>

    <app-pagination [total]="total" [pageSize]="pageSize" [pages$]="pages$" (change)="filter.emit({page: $event})"></app-pagination>

  </div>

  <div class="app-col-aside filter" [class.opened]="filterOpened">

    <div class="close-btn" [class.opened]="filterOpened" (click)="filterOpened = false"></div>

    <app-request-list-filter
      [resultsCount]="total"
      [backofficeView]="user.isBackOffice()"
      [availableFilters]="availableFilters"
      (filter)="filter.emit({filters: $event})"
      (showResults)="filterOpened = false">
    </app-request-list-filter>
  </div>
</div>

<div class="app-row">
  <!-- Горизонтальная инфа о позиции -->
  <div class="app-col app-table app-no-border actions">
    <div class="app-row">

      <div class="app-col">
        <span class="app-ghost-color">Изменена: </span>
        <span>{{ position.updatedDate | date : "dd.MM.yyyy" }} </span>
        <span class="app-ghost-color">{{ position.updatedDate | date : "HH:mm" }}</span>
      </div>

      <ng-container *ngIf="position.group">
        <div class="app-col separator"></div>

        <div class="app-col">
          <span class="app-ghost-color">Группа: </span>
          <span class="group-name" [title]="position.group.name">{{ position.group.name }}</span>
        </div>
      </ng-container>

      <div class="app-col separator"></div>

      <div class="app-col">
        <a [routerLink]="['/im', position.request.id]" [queryParams]="{positionId: position.id}">
          <span class="app-secondary-color">
            <uxg-icon shape="app-comment"></uxg-icon>
            <span>Перейти к чату по позиции</span>
          </span>
        </a>
      </div>
    </div>
  </div>

  <!-- Статус -->
  <div class="app-col-aside status" *ngIf="user.isBackOffice() && statuses">
    <div class="app-position-status-icon" [ngClass]="position.status"></div>
    <uxg-dropdown
      lg
      class="app-col"
      [placeholder]="position.statusLabel"
      [disabled]="statuses.length === 0"
      (select)="changeStatus.emit({status: $event, position: position})">
      <div uxgDropdownItem *ngFor="let status of statuses" [value]="status[0]">{{ status[1] }}</div>
    </uxg-dropdown>
  </div>
</div>


<div class="app-row">

  <!-- Табы -->
  <div class="app-col" *ngIf="!user.isCustomerApprover(); else approverView">
    <uxg-tabs class="app-tabs-border">
      <uxg-tab-title #historyTab [active]="true">История</uxg-tab-title>
      <uxg-tab-title #docTab>Документы</uxg-tab-title>
      <!-- Таб «Коммерческие предложения» временно скрыт, задача gpn_market-3188 -->
      <uxg-tab-title #offersTab [attr.disabled]="!position.linkedOffers.length" [hidden]="true">Коммерческие
        предложения
      </uxg-tab-title>
      <uxg-tab-title #inspectionTab [hidden]="!showInspection(position)">Изготовление</uxg-tab-title>
      <uxg-tab-title #deliveryTab [hidden]="!isAfterManufacturing(position) || isNotActual(position)">Доставка
      </uxg-tab-title>
    </uxg-tabs>
    <br/>
    <ng-container *uxgTab="historyTab">
      <app-request-position-history [requestPosition]="position"></app-request-position-history>
    </ng-container>
    <ng-container *uxgTab="docTab">
      <div class="app-row">
        <div class="app-col">
          <h3>Все документы позиции</h3>
        </div>

        <button uxgButton secondary iconText appUploadFile
                (select)="uploadDocuments.emit({ files: $event, position: position })"
                [multiple]="true" [disabled]="isNotActual(position)">
          <uxg-icon shape="app-upload"></uxg-icon>
          <span>Загрузить документы</span>
        </button>
      </div>
      <div class="documents" *ngFor="let dateWithDocs of datesWithDocuments">
        <h4>{{dateWithDocs.date}}</h4>
        <app-document-simple-list
          [gridable]="true"
          [enableUpload]="false"
          [uploadedDateHidden]="true"
          [documents]="dateWithDocs.documents">
        </app-document-simple-list>
      </div>
      <ng-container *ngIf="!datesWithDocuments || datesWithDocuments.length === 0">
        <br/>
        <h2 class="text-center" [style.opacity]="0.1">
          <uxg-icon shape="app-doc" size="270"></uxg-icon>
          <br/>
          К позиции пока не загружено ни <br/> одного документа
        </h2>
      </ng-container>
    </ng-container>
    <ng-container *uxgTab="offersTab">
      <app-request-commercial-proposal-list-deprecated [requestPosition]="position" [requestId]="requestId"
                                                       [isCustomerView]="user.isCustomer()"></app-request-commercial-proposal-list-deprecated>
    </ng-container>
    <ng-container *uxgTab="inspectionTab">
      <app-request-delivery-monitor-digital-inspector
        [position]="position"></app-request-delivery-monitor-digital-inspector>
    </ng-container>
    <ng-container *uxgTab="deliveryTab">
      <app-request-delivery-monitor [requestPosition]="position" [requestId]="requestId"></app-request-delivery-monitor>
    </ng-container>
  </div>
  <ng-template #approverView>
    <ng-container *ngIf="!datesWithDocuments || datesWithDocuments.length === 0; else documentList">
      <div class="app-col app-card approver">
        <br/>
        <h2 class="text-center" [style.opacity]="0.1">
          <uxg-icon shape="app-doc" size="270"></uxg-icon>
          <br/>
          К позиции пока не загружено ни <br/> одного документа
        </h2>
      </div>
    </ng-container>
    <ng-template #documentList>
      <div class="app-col">
        <div class="app-card">
          <div class="app-row app-align-items-center">
            <div class="app-col">
              <h3>Общие документы позиции</h3>
            </div>
            <div class="app-col-auto">
              <button uxgButton icon link (click)="folded = !folded">
                <uxg-icon shape="app-chevron" [attr.dir]="folded ? 'down' : 'up'"></uxg-icon>
              </button>
            </div>
          </div>
          <ng-container *ngIf="!folded">
            <div class="app-table app-no-border">
              <hr/>
              <div class="documents" *ngFor="let dateWithDocs of datesWithDocuments">
                <h4>{{dateWithDocs.date}}</h4>
                <app-document-simple-list
                  [gridable]="true"
                  [enableUpload]="false"
                  [uploadedDateHidden]="true"
                  [documents]="dateWithDocs.documents">
                </app-document-simple-list>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-template>
  </ng-template>

  <!-- Сайдбар с информацией -->
  <div class="app-col app-col-aside">
    <div class="app-row">
      <div class="app-col">
        <h3 class="sector-title">Общая информация о позиции</h3>

        <div class="app-ghost-color">Наименование МТР</div>
        <div class="app-bold position-name">{{ position.name }}</div>
        <br/>

        <div class="app-ghost-color">Количество</div>
        <div class="app-bold quantity">{{ position.quantity }} {{ position.measureUnit | lowercase }}</div>
        <br/>

        <div class="app-ghost-color">Необходимый срок поставки</div>
        <div class="app-bold delivery-date">
          <ng-container *ngIf="!position.isDeliveryDateAsap; else asap">
            {{ position.deliveryDate | date : "dd.MM.yyyy" }}
          </ng-container>
          <ng-template #asap>Как можно скорее</ng-template>
        </div>
        <br/>

        <div class="app-ghost-color">Базис поставки</div>
        <div class="app-bold delivery-basis">{{ position.deliveryBasis }}</div>
        <br/>

        <div class="app-ghost-color">Условия оплаты</div>
        <div class="app-bold paymentTerms">{{ position.paymentTerms }}</div>
        <br/>
        <ng-container *ngIf="position.startPrice">
          <div class="app-ghost-color">Начальная максимальная цена без НДС</div>
          <div class="app-bold price">{{ position.startPrice | currency: position.currency }}</div>
          <br/>
        </ng-container>
        <div class="app-ghost-color">Документ, в соответствии с которым необходимо изготовление</div>
        <div class="app-bold document">{{ position.productionDocument }}</div>
        <br/>

        <ng-container *ngIf="position.isDesignRequired">
          <div class="app-ghost-color">Необходимость РКД</div>
          <div class="app-bold rkd">Да, необходимо</div>
          <br/>
        </ng-container>

        <ng-container *ngIf="getRelatedServicesList(position)">
          <div class="app-ghost-color">Необходимость сопутствующих услуг</div>
          <div class="app-bold"> {{ getRelatedServicesList(position) }}</div>
          <br/>
        </ng-container>


        <ng-container *ngIf="position.comments">
          <div class="app-ghost-color">Дополнительные требования</div>
          <div class="app-bold comment">{{ position.comments }}</div>
          <br/>
        </ng-container>

        <div *ngIf="isBeforeContractSigning(position) && !user.isCustomer() && !user.isCustomerApprover()">
          <uxg-popover #more [openOnHover]="true">
            <button uxgButton secondary
                    uxgPopoverTrigger
                    (click)="edit.open()"
                    [disabled]="position.isEditingByAnotherUser || isNotActual(position)">
              <uxg-icon shape="app-pen"></uxg-icon>
              <span>Редактировать</span>
            </button>

            <ng-container *ngIf="position.isEditingByAnotherUser && !isNotActual(position)">
              <div *uxgPopoverContent="PopoverContentDirection.bottomRight" (click)="more.hide()">
                <div>Позиция находится на согласовании.</div>
                <div>Редактирование недоступно.</div>
              </div>
            </ng-container>
          </uxg-popover>
        </div>

        <uxg-modal #edit size="l">
          <h2>Редактирование общей информации по позиции</h2>
          <app-request-position-form
            *ngIf="edit.state"
            [requestId]="requestId"
            [(position)]="position"
            (cancel)="edit.close()"
            (positionChange)="positionChange.emit($event); edit.close()"
            [onDrafted]="onDrafted"
          ></app-request-position-form>
        </uxg-modal>
      </div>
    </div>
  </div>
</div>

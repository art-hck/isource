<ng-template #loading class="load-block">
  <span class="spinner spinner-md"></span>
</ng-template>

<ng-container *ngIf="(request$ | async) as request; else loading">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a [routerLink]="'../..'">Заявки</a> / <a [routerLink]="'..'">Заявка №{{request.number}}</a>
        </div>
        <h2><b>Рабочая конструкторская документация</b></h2>

        <ng-container *ngIf="routeData?.isBackoffice">
          <div class="clr-row w-100">
            <div class="clr-col-2">
              <button class="btn btn-primary-outline"
                      [disabled]="getPositions().length === 0"
                      title="{{getPositions().length > 0 ? 'Добавить перечень РКД' : 'Нет доступных позиций'}}"
                      (click)="onShowDesignDocumentationListModal()">
                <clr-icon shape="plus" class="is-solid"></clr-icon>
                <span> Добавить перечень РКД</span>
              </button>
            </div>
          </div>

          <!-- Модальное окно добавление перечня ркд -->
          <clr-modal [(clrModalOpen)]="showDesignDocumentationListModal"
                     [clrModalClosable]="false"
                     [clrModalSize]="'xl'">
            <h3 class="modal-title">Новый перечень РКД</h3>
            <div class="modal-body">
              <form [formGroup]="addDocumentationForm" class="form">
                <div formArrayName="addDocumentationListForm">
                  <div class="clr-row w-100">
                    <div class="clr-col-5">
                      <label>Наименование документа</label>
                    </div>
                    <div class="clr-col-3">
                      <label>Срок предоставления (календ. дней)</label>
                    </div>
                    <div class="clr-col-3">
                      <label>Срок корректировки (календ. дней)</label>
                    </div>
                  </div>
                  <ng-container *ngFor="let item of addDocumentationListForm.controls; let i=index">
                    <div class="form-block">
                      <div class="clr-form-control">
                        <div class="clr-row w-100" formGroupName="{{i}}">
                          <div class="clr-col-5">
                            <input id="name" type="text" formControlName="name" appFormControlInvalidClass="invalid"/>
                          </div>
                          <div class="clr-col-3">
                            <input id="adjustmentLimit" type="number" formControlName="adjustmentLimit"
                                   appFormControlInvalidClass="invalid"/>
                          </div>
                          <div class="clr-col-3">
                            <input id="receivingLimit" type="number" formControlName="receivingLimit"
                                   appFormControlInvalidClass="invalid"/>
                          </div>
                          <div class="clr-col-1">
                            <button type="button" class="btn btn-link btn-danger btn-delete" (click)="deleteItem(i)"
                                    title="Удалить из списка" *ngIf="i > 0">
                              <clr-icon shape="times" size="24"></clr-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <button class="btn btn-outline-primary" (click)="onAddNext()">
                    <clr-icon shape="plus"></clr-icon>
                    Добавить документ
                  </button>
                </div>
              </form>
              <div class="position-list">
                <div class="position-choice">
                  <b>Выберите позиции:</b>
                </div>
                <div class="clr-row w-100" *ngFor="let position of getPositions()">
                  <div class="clr-col-12">
                    <clr-checkbox-wrapper class="select-checkbox">
                      <input clrCheckbox type="checkbox"
                             value="{{ position }}"
                             [(ngModel)]="position.checked"
                             (change)="onSelectPosition(position)">
                      <label class="position-label nopadding">{{ position.name }}
                      </label>
                    </clr-checkbox-wrapper>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-link" (click)="onCloseAddDesignDocumentationModal()">Отмена</button>
              <button class="btn btn-primary" (click)="onAddDesignDocumentationList()"
                      [disabled]="addDocumentationForm.invalid || selectedPositions.length === 0">
                Добавить
              </button>
            </div>
          </clr-modal>

          <div class="design-documentation-card-list" *ngFor="let designDocumentation of designDocumentations; index as i">
            <div class="design-documentation-card">
              <div class="clr-row clr-align-items-center">
                <span class="position-name">
                  <span>{{designDocumentation.position.name}}</span>
                </span>
                <span class="design-actions">
                  <ng-container *ngIf="designDocumentation.status as status">
                    <ng-container [ngSwitch]="status">
                      <button disabled="" *ngSwitchCase="designDocStatus.ON_APPROVAL" class="btn btn-info-outline btn-label">На согласовании</button>
                      <button disabled="" *ngSwitchCase="designDocStatus.APPROVED" class="btn btn-info-outline btn-label status-success">Согласовано</button>
                      <button disabled="" *ngSwitchCase="designDocStatus.REJECTED" class="btn btn-info-outline btn-label status-warning">Отклонено заказчиком</button>
                    </ng-container>
                    <ng-container *ngIf="status === designDocStatus.NEW">
                      <clr-modal #confirmDelete [clrModalStaticBackdrop]="false">
                        <h3 class="modal-title">Удалить перечень полностью?</h3>
                        <h5 class="modal-body"><b>Отменить действие будет невозможно.</b></h5>
                        <div class="modal-footer">
                          <button type="button" class="btn" (click)="confirmDelete.close()">Отмена</button>
                          <button
                            (click)="removeDesignDocumentList(request, designDocumentation); confirmDelete.close()"
                            type="button" class="btn btn-danger">Удалить</button>
                        </div>
                      </clr-modal>
                      <button *ngIf="designDocumentation.status === 'NEW'" (click)="confirmDelete.open()" type="button"
                              class="btn">Удалить</button>
                    </ng-container>
                    <button class="btn btn-primary" *ngIf="canEditDesignDocList(designDocumentation)"
                            [clrLoading]="this.isSendingForApproval(designDocumentation) ? clrLoadingState.LOADING : clrLoadingState.DEFAULT"
                            [disabled]="!isSendOnApproveActive(designDocumentation)"
                            (click)="sendForApproval(designDocumentation)">Согласовать</button>
                  </ng-container>
                </span>
              </div>
              <div class="clr-row clr-align-items-center">
                <table class="document-list table table-noborder">
                  <thead>
                  <tr class="clr-row">
                    <th class="left clr-col-4">Наименование документа</th>
                    <th class="left clr-col-4">Документ</th>
                    <th class="left clr-col">Срок предоставления</th>
                    <th class="left clr-col">Срок корректировки</th>
                    <th class="left clr-col-2"></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr class="clr-row"
                      *ngFor="let designDoc of designDocumentation.designDocs; let designDocModel = null">
                    <td class="left clr-col-4">
                      <span *ngIf="!designDocModel">{{designDoc.name}}</span>
                      <input *ngIf="designDocModel" type="text" required [(ngModel)]="designDocModel.name"
                             appFormControlInvalidClass="invalid"/>
                    </td>
                    <td class="left clr-col-4">
                      <div class="form-group compact">
                        <app-document-simple-list
                          [documents]="designDoc.documents"
                          [enableUpload]="canUploadDocuments(designDoc, designDocumentation) && designDoc.id"
                          [limit]="5"
                          [enableDelete]="designDocumentation.status === designDocStatus.NEW"
                          (delete)="removeDocuments(request, designDoc, [$event])"
                          (selected)="onSelectDocument($event, designDoc)"
                        ></app-document-simple-list>
                        <label class="document-loading" *ngIf="isLoadingDesignDoc(designDoc)">Загрузка...</label>
                      </div>
                    </td>
                    <td class="left clr-col">
                      <span *ngIf="!designDocModel">{{designDoc.adjustmentDate}}</span>
                      <input *ngIf="designDocModel" type="text" required [(ngModel)]="designDocModel.adjustmentLimit"
                             appFormControlInvalidClass="invalid"/>
                    </td>
                    <td class="left clr-col">
                      <span *ngIf="!designDocModel">{{designDoc.receivingDate}}</span>
                      <input *ngIf="designDocModel" type="text" required [(ngModel)]="designDocModel.receivingLimit"
                             appFormControlInvalidClass="invalid"/>
                    </td>
                    <td class="left clr-col-2"
                        *ngIf="designDocumentation.status === designDocStatus.NEW">
                      <clr-modal #confirmDeleteDoc [clrModalStaticBackdrop]="false">
                        <h3 class="modal-title">Удалить документ {{ designDoc.name }}?</h3>
                        <h5 class="modal-body">
                          <div *ngIf="designDoc.documents.length > 0">Документ содержит загруженные файлы, которые тоже
                            будут удалены.
                          </div>
                          <div><b>Отменить действие будет невозможно.</b></div>
                        </h5>
                        <div class="modal-footer">
                          <button type="button" class="btn" (click)="confirmDeleteDoc.close()">Отмена</button>
                          <button type="button" class="btn btn-danger"
                                  (click)="removeDesignDocument(request, designDoc); confirmDeleteDoc.close()">Удалить
                          </button>
                        </div>
                      </clr-modal>
                      <div class="clr-row clr-justify-content-end">
                        <ng-container *ngIf="canEditDesignDoc(designDocumentation, designDoc) && !designDocModel">
                          <button (click)="confirmDeleteDoc.open()" type="button" class="btn">Удалить</button>
                          <button (click)="designDocModel = getDesignDocModel(designDoc)" class="btn">Изменить</button>
                        </ng-container>
                        <ng-container *ngIf="designDocModel">
                          <button (click)="designDocModel = null" class="btn btn-icon">Отмена</button>
                          <button [disabled]="isDesignDocModelInvalid(designDocModel)"
                                  (click)="editDesignDoc(request, designDocModel, designDocumentation)" type="button"
                                  class="btn btn-primary">Сохранить
                          </button>
                        </ng-container>
                      </div>
                    </td>
                  </tr>
                  <tr class="clr-row" *ngFor="let newDesignDocModel of newDesignDocModels; index as i">
                    <td class="clr-col-4">
                      <input type="text" [(ngModel)]="newDesignDocModel.name"/>
                    </td>
                    <td class="clr-col-4"></td>
                    <td class="clr-col">
                      <input type="text" [(ngModel)]="newDesignDocModel.adjustmentLimit"/>
                    </td>
                    <td class="clr-col">
                      <input type="text" [(ngModel)]="newDesignDocModel.receivingLimit"/>
                    </td>
                    <td class="clr-col-2 ">
                      <div class="clr-row clr-justify-content-end">
                        <button (click)="newDesignDocModels.splice(i, 1)" type="button" class="btn">Удалить</button>
                        <button [disabled]="isDesignDocModelInvalid(newDesignDocModel)"
                                (click)="addDesignDoc(request, newDesignDocModel, designDocumentation)" type="button"
                                class="btn btn-primary">Добавить
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr class="clr-row" *ngIf="canEditDesignDocList(designDocumentation)">
                    <td class="clr-col clr-justify-content-end">
                      <div class="clr-row clr-justify-content-end">
                        <button (click)="newDesignDocModels.push(getDesignDocModel())" type="button"
                                class="btn btn-primary">Добавить документ
                        </button>
                      </div>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="designDocumentation" *ngIf="routeData?.isCustomer">
          <div class="table designDocumentationHead">
            <div class="clr-row">
              <div class="left clr-col-4">ПОЗИЦИЯ</div>
              <div class="left clr-col-6">ДОКУМЕНТЫ</div>
              <div class="left clr-col-2"></div>
            </div>
          </div>

          <div class="table designDocumentationBody">
            <div class="clr-row" *ngFor="let designDocumentation of designDocumentations">
              <div class="left clr-col-4 title">{{designDocumentation.position.name}}</div>
              <div class="left clr-col-6">

                <ng-container *ngFor="let designDoc of designDocumentation.designDocs">
                  <app-document-simple-list
                    *ngIf="designDoc.type !== designDocumentationType.REMARK"
                    [documents]="designDoc.documents.length > 0 ? designDoc.documents : [getAwaitingDoc(designDoc)]"
                    [enableUpload]="false"
                    [limit]="5"
                  ></app-document-simple-list>
                </ng-container>


              </div>
              <div class="design-actions clr-col-2">
                <ng-container [ngSwitch]="designDocumentation.status">
                  <clr-dropdown *ngSwitchCase="designDocStatus.ON_APPROVAL" class="bottom-right">
                    <button class="btn btn-primary btn-dropdown" clrDropdownTrigger>
                      <div>Принять решение</div>
                      <clr-icon shape="caret down"></clr-icon>
                    </button>
                    <clr-dropdown-menu>
                      <div clrDropdownItem (click)="approve(designDocumentation)">
                        <clr-icon shape="check"></clr-icon>
                        <span> Согласовать</span>
                      </div>
                      <label clrDropdownItem>
                        <clr-icon shape="warning-standard" class="is-solid"></clr-icon>
                        <span> Приложить замечания</span>
                        <input type="file" (change)="reject(designDocumentation, $event.target.files[0])">
                      </label>

                    </clr-dropdown-menu>
                  </clr-dropdown>
                  <span *ngSwitchCase="designDocStatus.NEW" class="status status-info" disabled="">
                    <span>Новый</span>
                  </span>
                  <span *ngSwitchCase="designDocStatus.APPROVED" class="status status-success">
                    <clr-icon shape="check"></clr-icon>
                    <span> Согласовано</span>
                  </span>
                  <span *ngSwitchCase="designDocStatus.REJECTED" class="status status-warning">
                    <clr-icon shape="warning-standard" class="is-solid"></clr-icon>
                    <span> На доработке</span>
                  </span>
                </ng-container>
                <br/><br/>
                <app-document-simple-list
                  [documents]="getRemark(designDocumentation)[0].documents"
                  [enableUpload]="false"
                ></app-document-simple-list>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

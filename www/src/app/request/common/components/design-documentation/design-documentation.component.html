<ng-template #loading class="load-block">
  <span class="spinner spinner-md"></span>
</ng-template>

<ng-container *ngIf="(request$ | async) as request; else loading">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a [routerLink]="'../..'">Заявки</a> / <a [routerLink]="'..'">Заявка №{{request.number}}</a>
        </div>
        <h2><b>Рабочая конструкторская документация</b></h2>

        <ng-container *ngIf="routeData?.isBackoffice">
          <div class="clr-row w-100" *ngIf="getPositions().length > 0">
            <div class="clr-col-2">
              <button class="btn btn-primary-outline" (click)="onShowDesignDocumentationListModal()">
                <clr-icon shape="plus-circle" class="is-solid"></clr-icon>
                <span> Добавить перечень РКД</span>
              </button>
            </div>
          </div>

          <!-- Модальное окно добавление перечня ркд -->
          <clr-modal [(clrModalOpen)]="showDesignDocumentationListModal"
                     [clrModalClosable]="false"
                     [clrModalSize]="'xl'">
            <h3 class="modal-title">Новый перечень РКД</h3>
            <div class="modal-body">
              <form [formGroup]="addDocumentationForm" class="form">
                <div formArrayName="addDocumentationListForm">
                  <div class="clr-row w-100">
                    <div class="clr-col-5">
                      <label>Наименование документа</label>
                    </div>
                    <div class="clr-col-3">
                      <label>Срок предоставления (календ. дней)</label>
                    </div>
                    <div class="clr-col-3">
                      <label>Срок корректировки (календ. дней)</label>
                    </div>
                  </div>
                  <ng-container *ngFor="let item of addDocumentationListForm.controls; let i=index">
                    <div class="form-block">
                      <div class="clr-form-control">
                        <div class="clr-row w-100" formGroupName="{{i}}">
                          <div class="clr-col-5">
                            <input id="name" type="text" formControlName="name"
                                   [class.invalid]="isFieldInvalid(i, 'name')"/>
                          </div>
                          <div class="clr-col-3">
                            <input id="adjustmentLimit" type="number" formControlName="adjustmentLimit"
                                   [class.invalid]="isFieldInvalid(i, 'adjustmentLimit')"/>
                          </div>
                          <div class="clr-col-3">
                            <input id="receivingLimit" type="number" formControlName="receivingLimit"
                                   [class.invalid]="isFieldInvalid(i, 'receivingLimit')"/>
                          </div>
                          <div class="clr-col-1">
                            <button type="button" class="btn btn-link btn-danger btn-delete" (click)="deleteItem(i)"
                                    title="Удалить из списка" *ngIf="i > 0">
                              <clr-icon shape="times" size="18"></clr-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <button class="btn btn-link" (click)="onAddNext()" *ngIf="!addDocumentationForm.invalid">
                    Добавить документ
                  </button>
                </div>
              </form>
              <div class="position-list">
                <div class="position-choice">
                  <b>Выберите позиции:</b>
                </div>
                <div class="clr-row w-100" *ngFor="let position of getPositions()">
                  <div class="clr-col-12">
                    <clr-checkbox-wrapper class="select-checkbox">
                      <input clrCheckbox type="checkbox"
                             value="{{ position }}"
                             [(ngModel)]="position.checked"
                             (change)="onSelectPosition(position)">
                      <label class="position-label nopadding">{{ position.name }}
                      </label>
                    </clr-checkbox-wrapper>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-link" (click)="onCloseAddDesignDocumentationModal()">Отмена</button>
              <button class="btn btn-primary" (click)="onAddDesignDocumentationList()"
                      [disabled]="addDocumentationForm.invalid || selectedPositions.length === 0">
                Добавить
              </button>
            </div>
          </clr-modal>

          <div class="design-documentation-card-list" *ngFor="let designDocumentation of designDocumentations">
            <div class="design-documentation-card">
              <div class="clr-row clr-align-items-center">
                <span class="position-name clr-col">
                  <span>{{designDocumentation.position.name}}</span>
                </span>
                <span class="design-actions clr-col">
                  <ng-container *ngIf="designDocumentation.status as status">
                    <ng-container [ngSwitch]="status">
                      <button disabled="" *ngSwitchCase="designDocStatus.ON_APPROVAL" class="btn btn-info-outline btn-label">На согласовании</button>
                      <button disabled="" *ngSwitchCase="designDocStatus.APPROVAL" class="btn btn-info-outline btn-label status-success">Согласовано</button>
                      <button disabled="" *ngSwitchCase="designDocStatus.REJECTED" class="btn btn-info-outline btn-label status-warning">Отклонено заказчиком</button>
                    </ng-container>
                    <button *ngIf="canSendOnApprove(designDocumentation)" class="btn btn-primary"
                            [clrLoading]="this.isSendingForApproval(designDocumentation) ? clrLoadingState.LOADING : clrLoadingState.DEFAULT"
                            (click)="sendForApproval(designDocumentation)">Согласовать</button>
                  </ng-container>
                </span>

                <table class="document-list table table-noborder">
                  <thead>
                  <tr class="clr-row">
                    <th class="left clr-col-4">Наименование документа</th>
                    <th class="left clr-col-8">Документ</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr class="clr-row" *ngFor="let designDoc of designDocumentation.designDocs">
                    <td class="left clr-col-4">
                      {{designDoc.name}}
                    </td>
                    <td class="left clr-col-8">
                      <div class="form-group compact">
                        <app-document-simple-list
                          [documents]="designDoc.documents"
                          [enableUpload]="canUploadDocuments(designDoc, designDocumentation)"
                          [limit]="5"
                          (selected)="onSelectDocument($event, designDoc)"
                        ></app-document-simple-list>
                        <label class="document-loading" *ngIf="isLoadingDesignDoc(designDoc)">Загрузка...</label>
                      </div>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="designDocumentation" *ngIf="routeData?.isCustomer">
          <div class="table designDocumentationHead">
            <div class="clr-row">
              <div class="left clr-col-4">ПОЗИЦИЯ</div>
              <div class="left clr-col-6">ДОКУМЕНТЫ</div>
              <div class="left clr-col-2"></div>
            </div>
          </div>

          <div class="table designDocumentationBody">
            <div class="clr-row" *ngFor="let designDocumentation of designDocumentations">
              <div class="left clr-col-4 title">{{designDocumentation.position.name}}</div>
              <div class="left clr-col-6">

                <ng-container *ngFor="let designDoc of designDocumentation.designDocs">
                  <app-document-simple-list
                    [documents]="designDoc.documents"
                    [enableUpload]="false"
                    [limit]="5"
                    (selected)="onSelectDocument($event, designDoc)"
                  ></app-document-simple-list>
                  <label class="document-loading" *ngIf="isLoadingDesignDoc(designDoc)">Загрузка...</label>
                </ng-container>


              </div>
              <div class="design-actions clr-col-2">
                <ng-container [ngSwitch]="designDocumentation.status">
                  <clr-dropdown *ngSwitchCase="designDocStatus.ON_APPROVAL" class="bottom-right">
                    <button class="btn btn-primary btn-dropdown" clrDropdownTrigger>
                      <div>Принять решение</div>
                      <clr-icon shape="caret down"></clr-icon>
                    </button>
                    <clr-dropdown-menu>
                      <div clrDropdownItem (click)="approval(designDocumentation)">
                        <clr-icon shape="check"></clr-icon>
                        <span> Согласовать</span>
                      </div>
                      <label clrDropdownItem>
                        <clr-icon shape="warning-standard" class="is-solid"></clr-icon>
                        <span> Приложить замечания</span>
                        <input type="file" (change)="reject(designDocumentation, $event.target.files[0])">
                      </label>

                    </clr-dropdown-menu>
                  </clr-dropdown>
                  <span *ngSwitchCase="designDocStatus.NEW" class="status status-info" disabled="">
                    <span>Новый</span>
                  </span>
                  <span *ngSwitchCase="designDocStatus.APPROVAL" class="status status-success">
                    <clr-icon shape="check"></clr-icon>
                    <span> Согласовано</span>
                  </span>
                  <span *ngSwitchCase="designDocStatus.REJECTED" class="status status-warning">
                    <clr-icon shape="warning-standard" class="is-solid"></clr-icon>
                    <span> На доработке</span>
                  </span>
                </ng-container>
                <br/><br/>
                <app-document-simple-list
                  [documents]="getRemark(designDocumentation)[0].documents"
                  [enableUpload]="false"
                ></app-document-simple-list>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

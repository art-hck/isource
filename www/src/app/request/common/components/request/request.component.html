<!-- @TODO Выпилить после реализации попозиционного согласования -->
<div class="notification-bar" *ngIf="isOnApproval || isDraft">
  <div class="app-layout">
    <div class="app-row">
      <div class="app-col app-col-auto app-row app-align-items-center" *ngIf="isDraft">
        <div class="app-secondary-color">В заявке есть неопубликованные позиции в статусе Черновик</div>
        <button uxgButton secondary (click)="publish.emit()">Опубликовать все</button>
      </div>
      <div class="app-col app-col-auto app-row app-align-items-center" *ngIf="isOnApproval">
        <div class="app-secondary-color">В заявке есть позиции, требующие согласования</div>
        <button uxgButton secondary (click)="reject.emit()">Отклонить все</button>
        <button uxgButton primary (click)="approve.emit()">Согласовать все</button>
      </div>
    </div>
  </div>
</div>

<form [formGroup]="form">
  <div class="app-row">

    <!-- Контролы управления позициями -->
    <div class="app-col app-table app-no-border">
      <div class="app-row app-align-items-center">
        <!-- Царь-чекбокс -->
        <div class="app-col app-col-auto">
          <div class="app-row app-align-items-center">
            <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions" *ngFor="let form of [form]"></uxg-checkbox>
            <uxg-popover #popover>
              <button uxgButton uxgPopoverTrigger link icon>
                <uxg-icon shape="app-triangle down"></uxg-icon>
              </button>
              <div *uxgPopoverContent>
                <div>
                  <button uxgButton clear (click)="select('all'); popover.hide()">Все</button>
                </div>
                <div>
                  <button uxgButton clear (click)="select('none'); popover.hide()">Ни одного</button>
                </div>
                <div>
                  <button uxgButton clear (click)="select('groups'); popover.hide()">Группы</button>
                </div>
                <div>
                  <button uxgButton clear (click)="select('positions'); popover.hide()">Вне групп</button>
                </div>
              </div>
            </uxg-popover>
          </div>
        </div>

        <!-- Добавить в группу -->
        <div class="app-col app-col-auto" *ngIf="featureService.authorize('addRequestGroup')">
          <button uxgButton clear link [disabled]="checkedPositions.length === 0" (click)="addGroupModal.open()">
            <uxg-icon shape="app-group" size="16" class="is-solid"></uxg-icon>
            <span>Создать группу</span>
          </button>
        </div>

        <!-- Переместить в группу -->
        <div class="app-col app-col-auto" *ngIf="featureService.authorize('moveRequestGroup')">
          <button uxgButton clear link [disabled]="groups.length === 0 || checkedPositions.length === 0" (click)="moveGroupModal.open()">
            <uxg-icon shape="app-move" size="16" class="is-solid"></uxg-icon>
            <span>Переместить</span>
          </button>
        </div>

        <!-- Групповая смена статус -->
        <div class="app-col app-col-auto" *ngIf="user.isBackOffice()">
          <uxg-popover #status [openOnHover]="true">
            <button uxgButton uxgPopoverTrigger clear link [disabled]="!canChangeStatuses" (click)="changeStatusModal.open()">
              <uxg-icon shape="app-circle-arrow"></uxg-icon>
              <span>Сменить статус</span>
            </button>
            <div *uxgPopoverContent>
              <div>Вы можете изменить статус нескольких позиций сразу,</div>
              <div>если все позиции находятся в одном статусе.</div>
            </div>
          </uxg-popover>
        </div>

        <!-- Отклонить -->
        <!-- TODO Нереализованная фича, временно скрыл кнопку -->
        <!--<div class="app-col app-col-auto" *ngIf="featureService.available('approveRequest', user.roles)">
          <button uxgButton clear link [disabled]="checkedPositions.length === 0">
            <uxg-icon shape="app-cross"></uxg-icon>
            <span>Отклонить</span>
          </button>
        </div>-->

        <!-- Согласовать -->
        <!-- TODO Нереализованная фича, временно скрыл кнопку -->
        <!--<div class="app-col app-col-auto" *ngIf="featureService.available('approveRequest', user.roles)">
          <button uxgButton clear link [disabled]="checkedPositions.length === 0">
            <uxg-icon shape="app-check"></uxg-icon>
            <span>Согласовать</span>
          </button>
        </div>-->

        <!-- Отмена позиции заказчиком -->
        <div class="app-col app-basis-auto" *ngIf="user.isCustomer()">
          <button uxgButton clear [disabled]="checkedPositions.length === 0" (click)="cancelPositionModal.open()">Отменить</button>
        </div>
        <div class="app-col app-basis-auto" *ngIf="user.isBackOffice()">
          <uxg-popover #more>
            <button uxgButton uxgPopoverTrigger clear link>
              <uxg-icon shape="app-kebab"></uxg-icon>
            </button>
            <div *uxgPopoverContent (click)="more.hide()">
              <!-- Назначиь ответственного -->
              <div *ngIf="user.isBackOffice() && user.hasPermission(permissionType.POSITIONS_DISTRIBUTION_BETWEEN_BACKOFFICE_BUYERS)">
                <button uxgButton clear [disabled]="checkedPositions.length === 0" (click)="addResponsibleModal.open()">Назначить</button>
              </div>
              <div>
                <button uxgButton clear [disabled]="checkedPositions.length === 0" (click)="cancelPositionModal.open()">Отменить</button>
              </div>
              <div>
                <button uxgButton clear (click)="toggleGroups(true)">Свернуть группы</button>
              </div>
              <div>
                <button uxgButton clear (click)="toggleGroups(false)">Развернуть группы</button>
              </div>
            </div>
          </uxg-popover>
        </div>

        <div class="app-col app-col-auto">

          <uxg-popover #more [openOnHover]="true">
            <button uxgButton secondary iconText
                    uxgPopoverTrigger
                    [disabled]="request.isOlderTwoWeeks" (click)="addPositionModal.open()">
              <uxg-icon shape="app-plus"></uxg-icon>
              <span>Новая позиция</span>
            </button>

            <ng-container *ngIf="request.isOlderTwoWeeks">
              <div *uxgPopoverContent (click)="more.hide()">
                <div>Заявке больше двух недель.</div>
                <div>Добавление новых позиций недоступно.</div>
              </div>
            </ng-container>
          </uxg-popover>

          <!-- Фильтр  -->
          <!--          TODO Нереализованная фича, временно скрыл кнопку -->
          <!--          <button uxgButton secondary iconText [disabled]="true">-->
          <!--            <uxg-icon shape="app-sort2"></uxg-icon>-->
          <!--            <span>Фильтр</span>-->
          <!--          </button>-->
        </div>
      </div>
    </div>
    <div class="app-col app-col-aside"></div>
  </div>
  <div class="app-row">

    <!-- Список позиций -->
    <div class="app-col app-table" [class.disabled]="(status && status !== 'received') || positionsStatus && positionsStatus !=='received'">
      <ng-container *ngIf="positions.length === 0">
        <h2 class="text-center" [style.opacity]="0.1">
          <uxg-icon shape="add-text" size="270"></uxg-icon>
          <br/>
          К заявке пока не добавлено ни <br/> одной позиции
        </h2>
      </ng-container>
      <ng-container *ngFor="let formGroup of formPositions.controls">
        <!-- Позиция -->
        <ng-container *ngIf="asPosition(formGroup.get('position').value) as position">
          <a [href]="getPositionUrl(position)"
             (click)="navigateToPosition(position, $event)"
             class="app-row app-link-no-color"
             [ngClass]="{'canceled' : position.status === 'NOT_RELEVANT' || position.status === 'CANCELED'}">
            <div *ngTemplateOutlet="positionItem; context: { position: position, formGroup: formGroup }"></div>
          </a>
        </ng-container>

        <!-- Группа -->
        <ng-container *ngIf="asGroup(formGroup.get('position').value) as group">
          <!--a [href]="getPositionUrl(group)" (click)="navigateToPosition(group, $event)" class="app-row app-link-no-color app-row-group"-->
          <div class="app-row app-link-no-color app-row-group">
            <div *ngTemplateOutlet="groupItem; context:{ group: group, formGroup: formGroup }"></div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Правая колонка -->
    <div class="app-col app-col-aside">
      <app-request-aside-info [positions]="flatPositions" [request]="request"></app-request-aside-info>
    </div>
  </div>
</form>

<!-- Шаблон позиции -->
<ng-template #positionItem let-position="position" let-formGroup="formGroup">
  <div class="app-col app-grow-0" [formGroup]="formGroup">
    <uxg-checkbox formControlName="checked"></uxg-checkbox>
  </div>
  <div class="app-col app-bold item-title app-ellipsis">
    <a [href]="getPositionUrl(position)" (click)="navigateToPosition(position, $event)" class="app-link-no-color">
      {{ position.name }}
    </a>
  </div>
  <div class="app-col item-quantity app-ellipsis">
    <span class="quantity">{{ position.quantity }} </span>
    <span class="app-ghost-color">{{ position.measureUnit | lowercase }}</span>
  </div>
  <div class="app-col item-date app-ellipsis">
    <ng-container *ngIf="position.isDeliveryDateAsap; else deliveryDate">Как можно скорее</ng-container>
    <ng-template #deliveryDate>{{ position.deliveryDate | date : 'dd.MM.yyyy' }}</ng-template>
  </div>
  <div class="app-col item-status app-ellipsis">
    <ng-container
      *ngIf="user.isBackOffice() &&
      user.hasPermission(permissionType.POSITIONS_DISTRIBUTION_BETWEEN_BACKOFFICE_BUYERS) &&
      position.responsibleUser as user; else status">
      {{ position.responsibleUser.shortName }}
    </ng-container>
    <ng-template #status>
      <app-position-status [label]="position.statusLabel" [status]="position.status">
      </app-position-status>
    </ng-template>
  </div>
</ng-template>

<!-- Шаблон группы -->
<ng-template #groupItem let-group="group" let-formGroup="formGroup">
  <div class="app-col app-grow-0" [formGroup]="formGroup">
    <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions"></uxg-checkbox>
  </div>

  <div class="app-col" *ngIf="formGroup.get('folded') as folded">
    <div class="app-row">
      <div class="app-col item-title app-ellipsis">
        <span class="app-secondary-color">Группа: </span>
        <b>{{ group.name || "Без имени" }} </b>
        <span class="app-ghost-color">({{group.positions.length}})</span>
      </div>
      <!-- @TODO Implement -->
      <!--div class="app-col" [style.max-width.px]="460">
        2 как можно скорее | 01.01.2020 — ...
      </div-->
      <div class="app-col app-row app-grow-0">
        <uxg-icon class="app-accordion-title-icon" shape="app-chevron" [attr.dir]="folded.value ? 'down' : 'up'"
                  (click)="folded.setValue(!folded.value); $event.preventDefault(); $event.stopPropagation();"></uxg-icon>
      </div>
    </div>

    <!-- Позиции группы -->
    <div class="positions" *ngIf="!folded.value">
      <ng-container *ngFor="let childformGroup of asFormArray(formGroup.get('positions')).controls">
        <div class="app-row">
          <ng-container *ngTemplateOutlet="positionItem; context:{
              position: childformGroup.get('position').value,
              formGroup: childformGroup
          }"></ng-container>
        </div>
      </ng-container>
    </div>
  </div>
</ng-template>

<app-request-add-position-modal
  #addPositionModal
  [request]="request"
  [onDrafted]="onDrafted"
  (success)="addPosition.emit($event)"
  (uploadFromTemplate)="uploadFromTemplate.emit($event)"
  (cancel)="addPositionModal.close()"
></app-request-add-position-modal>

<!-- Модальное окно для назначения ответственного -->
<uxg-modal #addResponsibleModal size="s">
  <h2>Назначить позиции <span class="app-font-normal app-ghost-color">({{ checkedPositions?.length }})</span></h2>
  <div *ngIf="addResponsibleModal.state">
    <app-request-add-responsible
      [request]="request"
      [positions]="checkedPositions"
      (success)="addResponsible.emit($event)"
      (close)="addResponsibleModal.close()"
    ></app-request-add-responsible>
  </div>
</uxg-modal>
<!-- Модальное окно для отмены позиции -->
<uxg-modal #cancelPositionModal size="s">
  <h2>Отменить позиции <span class="app-font-normal app-ghost-color">({{ checkedPositions?.length }})</span></h2>
  <div class="app-section app-secondary-color">Будте внимательны, отменить операцию будет невозможно</div>
  <app-position-cancel [positions]="checkedPositions" [requestId]="request.id" (close)="cancelPositionModal.close()"></app-position-cancel>
</uxg-modal>
<!-- Модальное окно для смены статуса группы позиций -->
<uxg-modal #changeStatusModal size="s">
  <h2>Сменить статус позиций <span class="app-font-normal app-ghost-color">({{ checkedPositions?.length }})</span></h2>
  <ng-container *ngIf="changeStatusModal.state">
    <app-positions-status-change
      #positionsStatusChange
      [positions]="checkedPositions"
      [status]="checkedPositions[0]?.status"
      (changeStatus)="changeStatus.emit(); changeStatusModal.close()">
    </app-positions-status-change>
    <ng-template uxgModalFooter>
      <button type="button" uxgButton secondary lg uxgModalClose>Отмена</button>
      <button type="button" uxgButton primary lg
              [disabled]="!positionsStatusChange.valid()"
              [clrLoading]="positionsStatusChange.loading"
              (click)="positionsStatusChange.onChangeBtn()">
        Сменить
      </button>
    </ng-template>
  </ng-container>
</uxg-modal>

<uxg-modal size="s" #addGroupModal>
  <h2>Создать группу <span class="app-font-normal app-ghost-color">({{ checkedPositions?.length }})</span></h2>
  <ng-container *ngIf="addGroupModal.state">
    <app-request-group-form
      [request]="request"
      [positions]="checkedPositions"
      (success)="addGroup.emit($event)"
      (close)="addGroupModal.close()"
    ></app-request-group-form>
  </ng-container>
</uxg-modal>

<uxg-modal #moveGroupModal size="s">
  <h2>Переместить позиции <span class="app-ghost-color">({{ checkedPositions.length }})</span></h2>
  <app-request-move-group-modal
    *ngIf="moveGroupModal.state"
    [request]="request"
    [groups]="groups"
    [positions]="checkedPositions"
    (success)="addGroup.emit($event)"
    (close)="moveGroupModal.close()"
  ></app-request-move-group-modal>
</uxg-modal>

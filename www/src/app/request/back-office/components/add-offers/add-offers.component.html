<ng-container *ngIf="!request" class="load-block">
  <span class="spinner spinner-md"></span>
</ng-container>
<ng-container *ngIf="request">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a (click)="onRequestsClick()">Заявки</a> / <a (click)="onRequestClick()">Заявка №{{request.number}}</a>
        </div>
        <div class="clr-row w-100">
          <div class="clr-col-5">
            <h2>Коммерческие предложения</h2>
          </div>
          <div class="clr-col-7 add-contragent">
            <button class="btn btn-link add-contragent"
                    (click)="onShowAddContragentModal()"
                    *ngIf="requestPositions.length !== 0">
              <clr-icon shape="plus"></clr-icon>
              Добавить контрагента
            </button>
          </div>
        </div>
        <div class="clr-row w-100">
          <div class="clr-col-8">
            <div class="btn-group" *ngIf="requestPositions.length !== 0">
              <button class="btn btn-outline import-export"
                      (click)="onDownloadOffersTemplate()">
                Экспортировать шаблон
              </button>
              <button class="btn import-export"
                      (click)="onShowImportOffersExcel()">Импортировать КП
              </button>
            </div>

          </div>
          <div class="clr-col-2 send-offers">
            <button class="btn btn-primary send-offers"
                    (click)="wizard.open()"
            ><b>Создать процедуру</b>
            </button>
            <clr-wizard #wizard [(clrWizardOpen)]="lgOpen" clrWizardSize="lg">
              <clr-wizard-title><b>Новая процедура</b></clr-wizard-title>

              <clr-wizard-button [type]="'cancel'">Отмена</clr-wizard-button>
              <clr-wizard-button [type]="'previous'">Назад</clr-wizard-button>
              <clr-wizard-button [type]="'next'">Далее</clr-wizard-button>
              <clr-wizard-button [type]="'finish'">Опубликовать</clr-wizard-button>

              <clr-wizard-page
                [clrWizardPageNextDisabled]="procedureBasicDataForm.invalid && selectedProcedurePositions.length === 0"
                (clrWizardPageOnCancel)="resetWizardForm()">
                <ng-template clrPageTitle>Общие сведения</ng-template>
                <form [formGroup]="procedureBasicDataForm" class="form">
                  <div class="form-block">
                    <div class="clr-form-control">
                      <div class="clr-row w-100">
                        <label class="clr-control-label" for="procedureTitle">Наименование закупки</label>
                        <input id="procedureTitle" type="text" formControlName="procedureTitle"
                               [class.invalid]="isDataFieldValid('procedureTitle')"/>
                      </div>
                      <div class="clr-row w-100">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="dishonestSuppliersForbidden"
                                 id="dishonestSuppliersForbidden"
                                 formControlName="dishonestSuppliersForbidden">
                          <label class="clr-control-label nopadding">Требование к отсутствию участников закупки в
                            реестре недобросовестных поставщиков ФАС</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row w-100">
                        <div class="clr-col-6 dates">
                          <label class="clr-control-label left" for="dateEndRegistration">Прием заявок до:</label>
                          <input id="dateEndRegistration" placeholder="ДД.ММ.ГГГГ" type="date" clrDate
                                 formControlName="dateEndRegistration"
                                 [class.invalid]="isDataFieldValid('dateEndRegistration')"/>
                        </div>
                        <div class="clr-col-6 dates">
                          <label class="clr-control-label left" for="summingupDate">Подведение итогов:</label>
                          <input id="summingupDate" placeholder="ДД.ММ.ГГГГ" type="date" clrDate
                                 formControlName="summingupDate"
                                 [class.invalid]="isDataFieldValid('summingupDate')"/>
                        </div>
                      </div>

                      <div class="clr-row w-100">
                        <label class="clr-control-label">Позиции, участвующие в процедуре:</label>
                      </div>
                      <div class="position-list">
                        <div class="clr-row w-100">
                          <ng-container *ngFor="let control of positionsArray.controls; let i = index">
                            <clr-checkbox-wrapper class="select-checkbox">
                              <input class="checkbox select-checkbox" clrCheckbox type="checkbox"
                                     [formControl]="control"
                                     (change)="getSelectedPositions()">
                              <label class="nopadding">{{requestPositions[i].name}}</label>
                            </clr-checkbox-wrapper>
                          </ng-container>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </clr-wizard-page>

              <clr-wizard-page (clrWizardPageOnCancel)="resetWizardForm()">
                <ng-template clrPageTitle>Свойства процедуры</ng-template>
                <form [formGroup]="procedurePropertiesForm" class="form">
                  <div class="form-block">
                    <div class="clr-form-control">
                      <div class="clr-row w-100 padding-top">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="manualEndRegistration" id="manualEndRegistration"
                                 formControlName="manualEndRegistration">
                          <label class="clr-control-label nopadding">Досрочное завершение приема заявок на
                            участие</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row w-100">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="positionsRequiredAll" id="positionsRequiredAll"
                                 formControlName="positionsRequiredAll">
                          <label class="clr-control-label nopadding">Обязательная подача предложений на все
                            позиции</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row w-100">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="positionsAnalogs" id="positionsAnalogs"
                                 formControlName="positionsAnalogs">
                          <label class="clr-control-label nopadding">Разрешается прием аналогов</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row w-100">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="positionsAllowAnalogsOnly"
                                 id="positionsAllowAnalogsOnly" formControlName="positionsAllowAnalogsOnly">
                          <label class="clr-control-label nopadding">Возможность подачи аналогов без основного
                            предложения</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row w-100">
                        <clr-checkbox-wrapper>
                          <input type="checkbox" clrCheckbox name="positionsEntireVolume" id="positionsEntireVolume"
                                 formControlName="positionsEntireVolume">
                          <label class="clr-control-label nopadding">Заявка подается на весь закупаемый объем</label>
                        </clr-checkbox-wrapper>
                      </div>
                      <div class="clr-row">
                        <label class="clr-control-label" for="prolongateEndRegistration">Продление времени приема заявок
                          на участие
                          (минут)</label>
                        <input class="input-time" id="prolongateEndRegistration" type="number"
                               formControlName="prolongateEndRegistration"/>
                      </div>
                      <div class="clr-row w-100 padding-top">
                        <clr-radio-container>
                          <label class="clr-control-label nopadding radio-label"><b>Отображение наименований участников
                            в таблице</b></label>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsSuppliersVisibility" value="Name"/>
                            <label class="clr-control-label nopadding">Участники и их наименования отображаются в
                              таблице</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsSuppliersVisibility"
                                   value="NameHidden"/>
                            <label class="clr-control-label nopadding">Участники отображаются в таблице, но их
                              наименования скрыты</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsSuppliersVisibility" value="None"/>
                            <label class="clr-control-label nopadding">Участники не отображаются в таблице</label>
                          </clr-radio-wrapper>
                        </clr-radio-container>
                      </div>
                      <div class="clr-row w-100 padding-top">
                        <clr-radio-container>
                          <label class="clr-control-label nopadding radio-label"><b>Ограничение на подачу цен
                            участниками</b></label>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio name="positionsBestPriceType"
                                   formControlName="positionsBestPriceType" value="LowerStartPrice"/>
                            <label class="clr-control-label nopadding">Участники подают цены ниже начальной цены</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio name="positionsBestPriceType"
                                   formControlName="positionsBestPriceType" value="LowerPriceBest"/>
                            <label class="clr-control-label nopadding">Нет ограничений на цены участников</label>
                          </clr-radio-wrapper>
                        </clr-radio-container>
                      </div>
                      <div class="clr-row w-100 padding-top">
                        <clr-radio-container>
                          <label class="clr-control-label nopadding radio-label"><b>Отображение цен участников в
                            таблице</b></label>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsApplicsVisibility"
                                   value="PriceAndRating"/>
                            <label class="clr-control-label nopadding">Видны и цены, и рейтинг участников</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsApplicsVisibility"
                                   value="OnlyPrice"/>
                            <label class="clr-control-label nopadding">Видны только цены, подаваемые участниками</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsApplicsVisibility"
                                   value="OnlyRating"/>
                            <label class="clr-control-label nopadding">Виден только рейтинг цен</label>
                          </clr-radio-wrapper>
                          <clr-radio-wrapper>
                            <input type="radio" clrRadio formControlName="positionsApplicsVisibility" value="None"/>
                            <label class="clr-control-label nopadding">Цены и рейтинг скрыты</label>
                          </clr-radio-wrapper>
                        </clr-radio-container>
                      </div>
                    </div>
                  </div>
                </form>
              </clr-wizard-page>

              <clr-wizard-page (clrWizardPageOnCommit)="onPublishProcedure()"
                               (clrWizardPageOnCancel)="resetWizardForm()">
                <ng-template clrPageTitle>Документы</ng-template>
                ...
              </clr-wizard-page>
            </clr-wizard>
          </div>
          <div class="clr-col-2 send-offers">
            <button class="btn btn-primary send-offers"
                    *ngIf="selectedRequestPositions.length !== 0"
                    (click)="onPublishOffers()"
            ><b>Отправить на согласование</b>
            </button>
          </div>
        </div>
        <table class="table">
          <thead>
          <tr>
            <th class="position-name">
            </th>
            <th class="contragent-name" *ngFor="let supplier of suppliers">{{ supplier }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let requestPosition of requestPositions">
            <td class="position-name">
              <clr-checkbox-wrapper class="select-checkbox">
                <input type="checkboxselect-checkbox" clrCheckbox type="checkbox"
                       value="{{requestPosition}}"
                       [(ngModel)]="requestPosition.checked"
                       (change)="onSelectPosition(requestPosition)"
                       *ngIf="requestPosition.linkedOffers.length !== 0">
                <label class="position-label">{{ requestPosition.name }}
                  <span class="grey">{{requestPosition.quantity}} {{requestPosition.measureUnit}}</span>
                </label>
              </clr-checkbox-wrapper>
              <p class="delivery-date">
                Срок поставки:
                <span *ngIf="requestPosition.deliveryDate; else ASAP"><b>{{requestPosition.deliveryDate | date :'shortDate'}}</b></span>
                <ng-template #ASAP>
                  <b>как можно быстрее</b>
                </ng-template>
              </p>
            </td>
            <td class="contragent-name" *ngFor="let supplier of suppliers">
              <ng-container
                *ngIf="getSupplierLinkedOffers(
                  requestPosition.linkedOffers,
                  supplier
                ).length; else addLinkedOfferButton">
                <ng-container
                  *ngFor="let linkedOffer of getSupplierLinkedOffers(requestPosition.linkedOffers, supplier)">
                  <div class="offer" (click)="onShowOfferModal(linkedOffer)">
                    {{ linkedOffer.priceWithVat | currency : linkedOffer.currency }}
                    <p>{{linkedOffer.quantity}} {{linkedOffer.measureUnit}}</p>
                    <p class="delivery">{{linkedOffer.deliveryDate | date :'shortDate'}}</p>
                  </div>
                </ng-container>
              </ng-container>
              <ng-template #addLinkedOfferButton>
                <div class="add-offer" (click)="onShowAddOfferModal(requestPosition, supplier)">
                  <clr-icon shape="plus"></clr-icon>
                </div>
              </ng-template>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Модальное окно добавление контрагента -->
  <clr-modal [(clrModalOpen)]="showAddContragentModal"
             [clrModalClosable]="false">
    <h3 class="modal-title">Добавление контрагента</h3>
    <div class="modal-body">
      <form [formGroup]="contragentForm" novalidate>
        <input class="searchContragent" id="searchContragent" placeholder="Введите наименование или ИНН контрагента"
               (click)="onShowContragentList()"
               formControlName="searchContragent"
               autocomplete="off">
      </form>
      <div class="container-dropdown" *ngIf="showContragentList">
        <div class="contragent-list"
             *ngFor="let contragent of contragents | searchFilter: getSearchValue()"
             (click)="selectContragent(contragent)">
          {{contragent.shortName}}
        </div>
      </div>
      <div class="contragent-info" *ngIf="showContragentInfo">
        <p class="label-contragent">Наименование контрагента:</p>
        {{selectedContragent.shortName}}
        <p class="label-contragent">ИНН:</p>
        {{selectedContragent.inn}}
        <p class="label-contragent">КПП:</p>
        {{selectedContragent.kpp}}
        <p class="label-contragent">Email:</p>
        {{selectedContragent.email}}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-link" (click)="onCloseAddContragentModal()">Отмена</button>
      <button class="btn btn-primary"
              (click)="onAddContragent()"
              [disabled]="!selectedContragent"><b>Добавить</b>
      </button>
    </div>
  </clr-modal>

  <!-- Модальное окно добавления КП -->
  <clr-modal [(clrModalOpen)]="showAddOfferModal"
             [clrModalClosable]="false">
    <h3 class="modal-title">Добавьте КП</h3>
    <div class="modal-body">
      <form [formGroup]="offerForm" class="form">
        <div class="form-block">
          <div class="clr-form-control">
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="priceWithVat">Цена</label>
                <input type="number" id="priceWithVat" name="priceWithVat" formControlName="priceWithVat" min="0.1"
                       step="0.01" class="hidden-arrows text-right price"
                       [class.invalid]="isFieldValid('priceWithVat')">
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="currency">Валюта</label>
                <div class="select">
                  <select name="currency" id="currency" formControlName="currency"
                          [class.invalid]="isFieldValid('currency')">
                    <option value="RUB">
                      RUB
                    </option>
                    <option value="USD">
                      USD
                    </option>
                    <option value="EUR">
                      EUR
                    </option>
                    <option value="CHF">
                      CHF
                    </option>
                  </select>
                </div>
              </div>
            </div>
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="quantity">Количество</label>
                <input type="number" id="quantity" name="quantity" formControlName="quantity" min="0"
                       step="0.01" class="hidden-arrows text-right price"
                       [class.invalid]="isFieldValid('quantity')">
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="measureUnit">Единицы измерения</label>
                <input type="text" name="measureUnit" id="measureUnit" formControlName="measureUnit"
                       [class.invalid]="isFieldValid('measureUnit')">
              </div>
            </div>
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="deliveryDate">Срок поставки</label>
                <input id="deliveryDate" placeholder="дд.мм.гггг" type="date" clrDate
                       formControlName="deliveryDate"
                       [class.invalid]="isFieldValid('deliveryDate')"/>
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="paymentTerms">Условия оплаты</label>
                <input type="text" id="paymentTerms" formControlName="paymentTerms"
                       [class.invalid]="isFieldValid('paymentTerms')">
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="clr-row w-100">
        <div class="clr-col-6">
        </div>
        <div class="clr-col-6">
          <button class="btn btn-link" (click)="onCloseAddOfferModal()">Отмена</button>
          <button class="btn btn-primary" (click)="onAddOffer()" [disabled]="offerForm.invalid">Добавить</button>
        </div>
      </div>
    </div>
  </clr-modal>

  <!-- Модальное окно просмотра КП -->
  <clr-modal [(clrModalOpen)]="showOfferModal" clrModalSize="lg">
    <h3 class="modal-title">Предложение поставщика</h3>
    <div class="modal-body">
      <clr-datagrid class="clr-row offers-datagrid" *ngIf="selectedOffer">
        <clr-dg-column class="clr-col-2">Наименование к/а</clr-dg-column>
        <clr-dg-column class="clr-col-1 text-right">Цена</clr-dg-column>
        <clr-dg-column class="clr-col-1 text-right">Количество</clr-dg-column>
        <clr-dg-column class="clr-col-1 text-right">Дата поставки</clr-dg-column>
        <clr-dg-column class="clr-col-2">Условия оплаты</clr-dg-column>
        <clr-dg-column class="clr-col-2">КП</clr-dg-column>
        <clr-dg-column class="clr-col-1">ТП</clr-dg-column>

        <clr-dg-row>
          <clr-dg-cell class="clr-col-2">
            <a [href]="'assets/Отчет ООО Камский кабель.pdf'" [target]="'_blank'">{{selectedOffer.supplierContragentName}}</a>
          </clr-dg-cell>

          <clr-dg-cell class="clr-col-1 text-right offer-price">
            {{ selectedOffer.priceWithVat | currency : selectedOffer.currency }}
          </clr-dg-cell>

          <clr-dg-cell class="clr-col-1 text-right">{{selectedOffer.quantity}} {{selectedOffer.measureUnit}}
          </clr-dg-cell>

          <clr-dg-cell class="clr-col-1 text-right">{{selectedOffer.deliveryDate | date :'shortDate'}}
          </clr-dg-cell>

          <clr-dg-cell class="clr-col-2">{{selectedOffer.paymentTerms}}</clr-dg-cell>

          <clr-dg-cell class="clr-col-2">
            <app-document-simple-list
              [enableUpload]="true"
              [documents]="selectedOffer.documents"
              (selected)="onUploadDocuments($event, selectedOffer)"
            ></app-document-simple-list>
          </clr-dg-cell>

          <clr-dg-cell class="clr-col-1">
            <app-document-simple-list
              [enableUpload]="true"
              [documents]="selectedOffer.technicalProposals"
              (selected)="onUploadTechnicalProposals($event, selectedOffer)"
            ></app-document-simple-list>
          </clr-dg-cell>
        </clr-dg-row>
      </clr-datagrid>
    </div>
  </clr-modal>

  <clr-modal [(clrModalOpen)]="showImportOffersExcel">
    <h3 class="modal-title">Выберите файл для импорта</h3>
    <div class="modal-body">
      <form class="clr-form-control view">
        <div class="card">
          <div class="card-block">
            <div class="card-text">
              <span class="gray">
                Вы можете загрузить необходимый список предложений, скачав шаблон по нажатию кнопки
                Экспортировать шаблон и заполнив его
              </span>

              <app-document-upload-list
                [documents]="files"
                (fileSelected)="onChangeFilesList($event)">
              </app-document-upload-list>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary"
              type="button"
              (click)="onSendOffersTemplateFilesClick()"
              [disabled]="this.files.length === 0">
        Отправить
      </button>
    </div>
  </clr-modal>
</ng-container>

<ng-container *ngIf="!request" class="load-block">
  <span class="spinner spinner-md"></span>
</ng-container>
<ng-container *ngIf="request">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a (click)="onRequestsClick()">Заявки</a> / <a (click)="onRequestClick()">Заявка №{{request.number}}</a>
        </div>
        <div class="clr-row w-100">
          <div class="clr-col-5">
            <h2>Коммерческие предложения</h2>
          </div>
          <div class="clr-col-7 add-contragent">
            <button class="btn btn-link add-contragent"
                    (click)="onShowAddContragentModal()"
                    *ngIf="requestPositions.length !== 0">
              <clr-icon shape="plus"></clr-icon>
              Добавить контрагента
            </button>
          </div>
        </div>
        <div class="clr-row w-100">
          <div class="clr-col-10">
            <div class="btn-group" *ngIf="requestPositions.length !== 0">
              <button class="btn btn-outline import-export"
                      (click)="onDownloadOffersTemplate()">
                Экспортировать шаблон
              </button>
              <button class="btn import-export"
                      (click)="onShowImportOffersExcel()">Импортировать КП
              </button>
            </div>

          </div>
          <div class="clr-col-2 send-offers">
            <button class="btn btn-primary send-offers"
                    *ngIf="selectedRequestPositions.length !== 0"
                    (click)="onPublishOffers()"
            ><b>Отправить на согласование</b>
            </button>
          </div>
        </div>
        <table class="table">
          <thead>
          <tr>
            <th class="position-name">
            </th>
            <th class="contragent-name" *ngFor="let supplier of suppliers">{{ supplier }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let requestPosition of requestPositions">
            <td class="position-name">
              <clr-checkbox-wrapper class="select-checkbox">
                <input type="checkboxselect-checkbox" clrCheckbox type="checkbox"
                       value="{{requestPosition}}"
                       [(ngModel)]="requestPosition.checked"
                       (change)="onSelectPosition(requestPosition)"
                       *ngIf="requestPosition.linkedOffers.length !== 0">
                <label class="position-label">{{ requestPosition.name }}
                  <span class="grey">{{requestPosition.quantity}} {{requestPosition.measureUnit}}</span>
                </label>
              </clr-checkbox-wrapper>
              <p class="delivery-date">
                Срок поставки:
                <span *ngIf="requestPosition.deliveryDate; else ASAP"><b>{{requestPosition.deliveryDate | date :'shortDate'}}</b></span>
                <ng-template #ASAP>
                  <b>как можно быстрее</b>
                </ng-template>
              </p>
            </td>
            <td class="contragent-name" *ngFor="let supplier of suppliers">
              <ng-container
                *ngIf="getSupplierLinkedOffers(
                  requestPosition.linkedOffers,
                  supplier
                ).length; else addLinkedOfferButton">
                <ng-container
                  *ngFor="let linkedOffer of getSupplierLinkedOffers(requestPosition.linkedOffers, supplier)">
                  <div class="offer" (click)="onShowAddOfferModal(requestPosition, supplier, linkedOffer)">
                    {{ linkedOffer.priceWithVat | currency : linkedOffer.currency }}
                    <p>{{linkedOffer.quantity}} {{linkedOffer.measureUnit}}</p>
                    <p class="delivery">{{linkedOffer.deliveryDate | date :'shortDate'}}</p>
                  </div>
                </ng-container>
              </ng-container>
              <ng-template #addLinkedOfferButton>
                <div class="add-offer" (click)="onShowAddOfferModal(requestPosition, supplier)">
                  <clr-icon shape="plus"></clr-icon>
                </div>
              </ng-template>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Модальное окно добавление контрагента -->
  <clr-modal [(clrModalOpen)]="showAddContragentModal"
             [clrModalClosable]="false">
    <h3 class="modal-title">Добавление контрагента</h3>
    <div class="modal-body">
      <form [formGroup]="contragentForm" novalidate>
        <input class="searchContragent" id="searchContragent" placeholder="Введите наименование или ИНН контрагента"
               (click)="onShowContragentList()"
               formControlName="searchContragent"
               autocomplete="off">
      </form>
      <div class="container-dropdown" *ngIf="showContragentList">
        <div class="contragent-list"
             *ngFor="let contragent of contragents | searchFilter: getSearchValue()"
             (click)="selectContragent(contragent)">
          {{contragent.shortName}}
        </div>
      </div>
      <div class="contragent-info" *ngIf="showContragentInfo">
        <p class="label-contragent">Наименование контрагента:</p>
        {{selectedContragent.shortName}}
        <p class="label-contragent">ИНН:</p>
        {{selectedContragent.inn}}
        <p class="label-contragent">КПП:</p>
        {{selectedContragent.kpp}}
        <p class="label-contragent">Email:</p>
        {{selectedContragent.email}}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-link" (click)="onCloseAddContragentModal()">Отмена</button>
      <button class="btn btn-primary"
              (click)="onAddContragent()"
              [disabled]="!selectedContragent"><b>Добавить</b>
      </button>
    </div>
  </clr-modal>

  <!-- Модальное окно добавления/редактирования КП -->
  <clr-modal [(clrModalOpen)]="showAddOfferModal"
             [clrModalClosable]="false">
    <div class="modal-body">
      <form [formGroup]="offerForm" class="form">
        <div class="form-block">
          <div class="clr-form-control">
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="priceWithVat">Цена</label>
                <input type="number" id="priceWithVat" name="priceWithVat" formControlName="priceWithVat" min="0.1"
                       step="0.01" class="hidden-arrows text-right price"
                       [class.invalid]="isFieldValid('priceWithVat')">
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="currency">Валюта</label>
                <div class="select">
                  <select name="currency" id="currency" formControlName="currency"
                          [class.invalid]="isFieldValid('currency')">
                    <option value="RUB">
                      RUB
                    </option>
                    <option value="USD">
                      USD
                    </option>
                    <option value="EUR">
                      EUR
                    </option>
                    <option value="CHF">
                      CHF
                    </option>
                  </select>
                </div>
              </div>
            </div>
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="quantity">Количество</label>
                <input type="number" id="quantity" name="quantity" formControlName="quantity" min="0"
                       step="0.01" class="hidden-arrows text-right price"
                       [class.invalid]="isFieldValid('quantity')">
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="measureUnit">Единицы измерения</label>
                <input type="text" name="measureUnit" id="measureUnit" formControlName="measureUnit"
                       [class.invalid]="isFieldValid('measureUnit')">
              </div>
            </div>
            <div class="clr-row w-100">
              <div class="clr-col-4">
                <label class="clr-control-label" for="deliveryDate">Срок поставки</label>
                <input id="deliveryDate" placeholder="дд.мм.гггг" type="date" clrDate
                       formControlName="deliveryDate"
                       [class.invalid]="isFieldValid('deliveryDate')"/>
              </div>
              <div class="clr-col-8">
                <label class="clr-control-label" for="paymentTerms">Условия оплаты</label>
                <input type="text" id="paymentTerms" formControlName="paymentTerms"
                       [class.invalid]="isFieldValid('paymentTerms')">
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="clr-row w-100">
        <div class="clr-col-6">
        </div>
        <div class="clr-col-6">
          <button class="btn btn-link" (click)="onCloseAddOfferModal()">Отмена</button>
          <button *ngIf="!editMode" class="btn btn-primary" (click)="onAddOffer()" [disabled]="offerForm.invalid">
            Добавить
          </button>
          <button *ngIf="editMode" class="btn btn-primary" (click)="onEditOffer()" [disabled]="offerForm.invalid">
            Сохранить
          </button>
        </div>
      </div>
    </div>
  </clr-modal>

  <clr-modal [(clrModalOpen)]="showImportOffersExcel">
    <h3 class="modal-title">Выберите файл для импорта</h3>
    <div class="modal-body">
      <form class="clr-form-control view">
        <div class="card">
          <div class="card-block">
            <div class="card-text">
              <span class="gray">
                Вы можете загрузить необходимый список предложений, скачав шаблон по нажатию кнопки
                Экспортировать шаблон и заполнив его
              </span>

              <app-document-upload-list
                [documents]="files"
                (fileSelected)="onChangeFilesList($event)">
              </app-document-upload-list>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary"
              type="button"
              (click)="onSendOffersTemplateFilesClick()"
              [disabled]="this.files.length === 0">
        Отправить
      </button>
    </div>
  </clr-modal>
</ng-container>

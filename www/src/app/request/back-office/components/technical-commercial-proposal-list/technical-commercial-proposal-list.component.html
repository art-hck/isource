<ng-container *ngIf="(request$ | async) as request; else placeholder">
  <ng-container *ngIf="(proposals$ | async) as proposals; else placeholder" [formGroup]="form">
    <!-- actions -->
    <div class="app-row">
      <div class="app-col">
        <div class="app-table app-no-border">

          <div class="secondary-action app-row app-justify-content-end">
            <div class="app-col app-basis-auto app-grow-0">
              <span class="analytical-report-link" (click)="store.dispatch(downloadAnalyticalReport(requestId))">Аналитическая справка</span>
            </div>
          </div>

          <div class="app-row  app-align-items-center">
            <ng-container *ngIf="view==='grid'">
              <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions"></uxg-checkbox>
              <uxg-popover #selectPopover>
                <button uxgButton uxgPopoverTrigger link icon><clr-icon shape="app-triangle down"></clr-icon></button>
                <div *uxgPopoverContent>
                  <div><button uxgButton clear (click)="selectPopover.hide()">Все</button></div>
                  <div><button uxgButton clear (click)="selectPopover.hide()">Ни одного</button></div>
                </div>
              </uxg-popover>
            </ng-container>
            <div>
              <span class="app-secondary-color">показать: </span>
              <uxg-popover #viewPopover>
                <button uxgButton uxgPopoverTrigger link clear [ngSwitch]="view">
                 <span *ngSwitchCase="'grid'"><b>по позициям матрица</b></span>
                 <span *ngSwitchCase="'list'"><b>по поставщикам</b></span>
                </button>
                <div *uxgPopoverContent>
                  <div><button uxgButton clear (click)="view='grid'; viewPopover.hide()">по позициям матрица</button></div>
                  <div><button uxgButton clear (click)="view='list'; viewPopover.hide()">по поставщикам</button></div>
                </div>
              </uxg-popover>
            </div>
            <div class="app-col"></div>
            <div [ngSwitch]="view">

              <!-- Создать процедуру @TODO временно скрыто  -->
              <!--button uxgButton secondary iconText (click)="procedureModal.open()"
                      *ngIf="featureService.authorize('createProcedure')">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Создать процедуру</span>
              </button-->

              <!-- Новое ТКП  -->
              <button *ngSwitchCase="'list'" uxgButton secondary iconText (click)="showForm = true"
                      [disabled]="(availablePositions$ | async)?.length === 0">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Новое ТКП</span>
              </button>

              <!-- Добавить столбец контрагента  -->
              <button *ngSwitchCase="'grid'" uxgButton secondary iconText (click)="showForm = true"
                      [disabled]="(availablePositions$ | async)?.length === 0">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Контрагент</span>
              </button>

              <!-- Новое ТКП шаблона -->
              <button uxgButton primary iconText (click)="uploadTemplateModal.open()">
                <clr-icon shape="app-plus"></clr-icon>
                <span>ТКП из шаблона</span>
              </button>

              <!-- Отправить на согласование -->
              <button *ngSwitchCase="'grid'" uxgButton primary [disabled]="selectedPositions?.length === 0">
                Отправить на согласование
              </button>
            </div>
          </div>
        </div>
      </div>
      <div @sidebarHide *ngIf="view==='list'" class="app-col app-col-aside"></div>
    </div>

    <!-- grid -->
    <div class="grid-table" *ngIf="view ==='grid'" [formGroup]="form">
      <!-- contragents -->
      <div class="contragents-row">
        <div #gridRow class="app-row grid-row">
          <div class="app-col grid-cell app-bold" *ngFor="let proposal of proposals">
            <app-contragent-info-link [contragent]="proposal.supplier"></app-contragent-info-link>
          </div>
        </div>

        <button class="left" *ngIf="gridRow.scrollLeft > 0" uxgButton primary icon (click)="scrollLeft()"><clr-icon shape="app-chevron" dir="left"></clr-icon></button>
        <button class="right" *ngIf="gridRow.scrollLeft === 0 || gridRow.scrollLeft < gridRow.scrollWidth - gridRow.offsetWidth" uxgButton primary icon (click)="scrollRight()"><clr-icon shape="app-chevron" dir="right"></clr-icon></button>
      </div>

      <!-- positions -->
      <div class="position-row" *ngFor="let proposalPos of proposalsByPositions$ | async; index as i" formArrayName="positions">
        <div class="app-row app-align-items-center app-section" [formGroupName]="i">
          <uxg-checkbox class="app-control" #checked formControlName="checked"></uxg-checkbox>
          <label (click)="checked.check($event)"><b>&nbsp; {{proposalPos.position.name}}</b></label>
          <div class="app-col"></div>
          <div class="app-success-color app-bold" *ngIf="isReviewed(proposalPos)">
            <clr-icon shape="app-check"></clr-icon>
            <span>Выбран победитель</span>
          </div>
        </div>
        <div #gridRow class="grid-row app-row app-section items-row">
          <ng-container *ngFor="let proposal of proposals">
            <button class="grid-item grid-cell app-col" *ngIf="getProposalPosition(proposal, proposalPos.position) as p; else emptyProposal">
              <div class="app-row app-align-items-center">
                <h3 class="app-col">
                  <span>{{(p?.priceWithoutVat * p?.quantity) | number:'1.0-2'}} </span>
                  <span class="app-ghost-color">{{getCurrencySymbol(p.currency, "narrow")}}</span>
                </h3>
                <ng-container [ngSwitch]="p.status">
                  <div class="winner" *ngSwitchCase="'APPROVED'">
                    <svg height="25" width="101" viewBox="0 0 101 25" xmlns="http://www.w3.org/2000/svg">
                      <path d="M0 0H101V25H0L7 12.5L0 0Z" fill="#0EA04B"></path>
                      <text y="13" x="92" fill="#fff" alignment-baseline="middle" text-anchor="end">Победитель</text>
                    </svg>
                  </div>
                  <div class="app-ghost-color" *ngSwitchCase="'REJECTED'">
                    <clr-icon shape="app-check"></clr-icon>
                  </div>
                </ng-container>
              </div>
              <div>
                <!-- Количество, цена за ед. -->
                <span [ngClass]="!isQuantityValid(p) ? 'app-error-color app-bold' : ''">{{p.quantity}} {{p.measureUnit}}</span>
                <span class="app-ghost-color"> | </span>
                <span class="app-ghost-color">{{p.priceWithoutVat | number:'1.0-2'}} </span>
                <span class="app-ghost-color">{{getCurrencySymbol(p.currency, "narrow")}}/{{p.measureUnit}}</span>
                <br/>

                <!-- Дата поставки. -->
                <span [ngClass]="!isDateValid(p) ? 'app-error-color app-bold' : ''">{{p.deliveryDate | date:"dd.MM.yyyy"}}</span>
                <span class="app-ghost-color"> доставка</span>
              </div>
              <div class="app-ellipsis app-secondary-color">{{ p.manufacturingName }}</div>
            </button>
            <ng-template #emptyProposal>
              <button class="grid-item grid-cell app-col empty" [disabled]="proposal.status!=='DRAFT'">
                <clr-icon class="app-link" *ngIf="proposal.status==='DRAFT'; else notProvided" shape="app-plus-big" size="24"></clr-icon>
                <ng-template #notProvided><b>Не предоставлено</b></ng-template>
              </button>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- list -->
    <div class="app-row" *ngIf="view==='list'">
      <div class="app-col app-technical-commercial-proposal-list">
        <app-technical-commercial-proposal-form
          *ngIf="(proposalsLength$ | async) === 0 || showForm"
          [request]="request"
          [closable]="proposals.length > 0"
          (close)="showForm = false"
        ></app-technical-commercial-proposal-form>

        <ng-container *ngFor="let proposal of proposals; trackBy: trackByProposalId">
          <app-request-technical-commercial-proposal
            [request]="request"
            [technicalCommercialProposal]="proposal"
          ></app-request-technical-commercial-proposal>
        </ng-container>
      </div>

      <div class="app-col-aside">
        <technical-commercial-proposal-filter></technical-commercial-proposal-filter>
      </div>
    </div>

    <!-- modals -->
    <clr-modal clrModalSize="lg" #procedureModal>
      <h2 class="modal-title">Создание новой процедуры</h2>
      <div class="modal-body" [style.overflow]="'visible'">
        <ng-container *ngIf="getPositions(proposals) as positions">
          <app-request-procedure-create
            *ngIf="procedureModal._open"
            [request]="request"
            [positions]="positions"
            [contragents]="getContragents(proposals)"
            [publicAccess]="false"
            (complete)="procedureModal.close()"
          ></app-request-procedure-create>
        </ng-container>
      </div>
    </clr-modal>
    <clr-modal #uploadTemplateModal [clrModalSize]="'lg'">
      <h2 class="modal-title"><b>Загрузить технико-коммерческие предложения из шаблона</b></h2>
      <div class="modal-body" *ngIf="uploadTemplateModal._open">
        <div class="app-secondary-color template">
          Вы можете загрузить ТКП списком, если заполните шаблон xls таблицы (<a (click)="store.dispatch(downloadTemplate(requestId))"><b>скачать
          шаблон</b></a>), и загрузите файл в систему. Если указать несколько поставщиков, то будет создано несколько ТКП.
        </div>
        <div class="dragAndDropArea">
          <app-template-upload (fileSelected)="files = $event"></app-template-upload>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" uxgButton secondary lg (click)="uploadTemplateModal.close()">Отмена</button>
        <button uxgButton primary lg (click)="store.dispatch(uploadTemplate(requestId, files)); uploadTemplateModal.close()"
                [disabled]="files.length === 0">
          Загрузить
        </button>
      </div>
    </clr-modal>
  </ng-container>
</ng-container>

<ng-template #placeholder>
  <div class="app-row">
    <div class="app-col">
      <div class="placeholder" *ngFor="let i of [].constructor(10)"></div>
    </div>
    <div class="app-col-aside"></div>
  </div>
</ng-template>

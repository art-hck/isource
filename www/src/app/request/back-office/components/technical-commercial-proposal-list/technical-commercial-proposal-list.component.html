<ng-container *ngIf="(status$ | async) !== 'fetching' && (requestStatus$ | async) !== 'fetching'; else placeholder">
  <ng-container *ngIf="(request$ | async) as request">
    <ng-container *ngIf="(proposals$ | async) as proposals" [formGroup]="form">
      <!-- actions -->
      <div class="app-row" [class.app-layout]="view !== 'list'">
        <div class="app-col">
          <div class="app-row app-justify-content-end analytical-report">
            <button uxgButton clear class="app-link" (click)="store.dispatch(downloadAnalyticalReport(requestId))">
              <span>Аналитическая справка </span>
              <uxg-icon shape="app-download"></uxg-icon>
            </button>
          </div>
          <div class="app-table app-no-border">
            <div class="app-row app-align-items-center">
              <ng-container *ngIf="view === 'grid'">
                <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions" *ngFor="let c of [form.get('positions')]">
                </uxg-checkbox>
                <uxg-popover #selectPopover>
                  <button uxgButton uxgPopoverTrigger link icon>
                    <uxg-icon shape="app-triangle down"></uxg-icon>
                  </button>
                  <div *uxgPopoverContent>
                    <div>
                      <button uxgButton clear (click)="form.get('checked').setValue(true); selectPopover.hide()">Все</button>
                    </div>
                    <div>
                      <button uxgButton clear (click)="form.get('checked').setValue(false); selectPopover.hide()">Ни одного</button>
                    </div>
                  </div>
                </uxg-popover>
              </ng-container>
              <div>
                <span class="app-secondary-color">показать: </span>
                <uxg-popover #viewPopover>
                  <button uxgButton uxgPopoverTrigger link clear [ngSwitch]="view">
                    <span *ngSwitchCase="'simple-grid'"><b>по позициям</b></span>
                    <span *ngSwitchCase="'grid'"><b>по позициям матрица</b></span>
                    <span *ngSwitchCase="'list'"><b>по поставщикам</b></span>
                  </button>
                  <div *uxgPopoverContent>
<!--                    <div>-->
<!--                      <button uxgButton clear (click)="switchView('simple-grid')">по позициям</button>-->
<!--                    </div>-->
                    <div>
                      <button uxgButton clear (click)="switchView('grid')">по позициям матрица</button>
                    </div>
                    <div>
                      <button uxgButton clear (click)="switchView('list')">по поставщикам</button>
                    </div>
                  </div>
                </uxg-popover>
              </div>
              <div class="app-col"></div>
              <div [ngSwitch]="view">

                <button uxgButton secondary iconText (click)="procedureModalPayload = {action: 'create'}"
                        *ngIf="featureService.authorize('createProcedure')">
                  <uxg-icon shape="app-plus"></uxg-icon>
                  <span>Создать процедуру</span>
                </button>

                <!-- Новое ТКП  -->
                <button *ngSwitchCase="'list'" uxgButton secondary iconText (click)="showForm = true">
                  <uxg-icon shape="app-plus"></uxg-icon>
                  <span>Новое ТКП</span>
                </button>

                <!-- Добавить столбец контрагента  -->
                <button *ngSwitchCase="'grid'" uxgButton secondary iconText
                        [disabled]="allPositionsOnReview()"
                        (click)="addContragentModal.open()">
                  <uxg-icon shape="app-plus"></uxg-icon>
                  <span>Контрагент</span>
                </button>

                <!-- Новое ТКП шаблона -->
                <button uxgButton primary iconText (click)="uploadTemplateModal.open()">
                  <uxg-icon shape="app-plus"></uxg-icon>
                  <span>ТКП из шаблона</span>
                </button>

                <!-- Отправить на согласование -->
                <button *ngSwitchCase="'grid'" uxgButton primary
                        [disabled]="selectedPositions?.length === 0 || (status$ | async) !=='received'"
                        (click)="store.dispatch(publishPositions(selectedPositions))">
                  Отправить на согласование
                </button>
              </div>
            </div>
          </div>
        </div>
        <div @sidebarHide *ngIf="view === 'list'" class="app-col app-col-aside detachable"></div>
      </div>

      <!-- grid -->
      <div *ngIf="(view !=='list' && proposals.length + (procedures$ | async).length)" [ngClass]="{
          'grid-table': view === 'grid',
          'simple-grid-table': view === 'simple-grid',
          'disabled': (status$ | async) === 'updating'}"
      >
        <app-grid-contragents
          *ngIf="view === 'grid' && suppliers.length"
          [gridRows]="gridRows"
          [positionCell]="true"
          [suppliers]="suppliers(proposals)"
        ></app-grid-contragents>

        <!-- procedure info -->
        <div class="position-row" *ngFor="let procedure of procedures$ | async; trackBy: trackById">
          <app-procedure-grid [procedure]="procedure"
                              [source]="'tcp'"
                              (bargain)="procedureModalPayload = {action: 'bargain', procedure: procedure}"
                              (prolong)="prolongModalPayload = procedure"></app-procedure-grid>
        </div>

        <ng-container *ngIf="suppliers.length || view === 'simple-grid'" formArrayName="positions">
          <app-grid-row
            *ngFor="let proposalsByPos of proposalsByPositions$ | async; trackBy trackByProposalByPositionId; index as i"
            [position]="proposalsByPos.position"
            [suppliers]="suppliers(proposals)"
            [proposals]="converProposalPosition(proposalsByPos)"
            [simpleView]="view === 'simple-grid'"
            [isReviewed]="true"
            [getProposal]="getProposalPosBySupplier(proposalsByPos)"
            [getSupplier]="getSupplierByProposalPos(proposals)"
            [editable]="!isReviewed(proposalsByPos) && !isOnReview(proposalsByPos)"
            [formGroupName]="i"
            (show)="proposalModalData = {proposalPosition: $event.sourceProposal, proposal: getProposalByProposalPosition($event.sourceProposal, proposals)}"
            (edit)="addProposalPosition(getProposalByProposalPosition($event.sourceProposal, proposals), proposalsByPos.position)"
            (create)="addProposalPosition(getProposalBySupplier($event, proposals), proposalsByPos.position)"
          >
            <ng-template #position>
              <div class="grid-cell app-col">
                <div class="app-row" style="flex-wrap: nowrap">
                  <uxg-checkbox class="app-control" #checked
                                formControlName="checked"
                                [disabled]="isReviewed(proposalsByPos) || isOnReview(proposalsByPos) || proposalsByPos.data.length === 0">
                  </uxg-checkbox>
                  <div class="app-row app-flex-column">
                    <label (click)="checked.check($event)"><b>{{proposalsByPos.position.name}}</b></label>

                    <div class="app-secondary-color">
                      <span>{{proposalsByPos.position.quantity}}</span>
                      <span class="app-ghost-color">{{proposalsByPos.position.measureUnit}}</span>
                      <span class="app-ghost-color"> | </span>
                      <span *ngIf="proposalsByPos.position.isDeliveryDateAsap; else deliveryDate">как можно скорее</span>
                      <ng-template #deliveryDate><span>{{proposalsByPos.position.deliveryDate | date:"dd.MM.yyyy"}}</span></ng-template>
                    </div>
                    <div class="app-col"></div>
                    <div class="app-success-color app-bold" *ngIf="isReviewed(proposalsByPos)">
                      <uxg-icon shape="app-check"></uxg-icon>
                      <span>Выбран победитель</span>
                    </div>
                    <div class="app-ghost-color app-bold" *ngIf="isOnReview(proposalsByPos)">
                      <uxg-icon shape="app-waiting"></uxg-icon>
                      <span>На согласовании</span>
                    </div>
                    <div class="app-warning-color app-bold" *ngIf="isSentToEdit(proposalsByPos)">
                      <uxg-icon shape="app-warning"></uxg-icon>
                      <span>На доработке</span>
                    </div>
                    <div class="app-ghost-color app-bold" *ngIf="isDraft(proposalsByPos)">
                      <uxg-icon shape="app-draft"></uxg-icon>
                      <span>Черновик</span>
                    </div>
                    <ng-container *ngIf="canRollback(proposalsByPos.position)">
                      <button uxgButton primary type="button" [style.min-width.px]="135" (click)="store.dispatch(rollback(proposalsByPos.position))">
                        Отозвать <span class="cancel-timer"> {{ proposalsByPos.position.statusChangedDate | countdownTimer: rollbackDuration }} </span>
                      </button>
                    </ng-container>
                  </div>
                </div>
              </div>
            </ng-template>
          </app-grid-row>
        </ng-container>

      </div>

      <!-- list -->
      <div class="app-row" *ngIf="view === 'list'">
        <div class="app-col app-technical-commercial-proposal-list" [class.disabled]="(status$ | async) !== 'received'">
          <app-technical-commercial-proposal-form
            *ngIf="proposals?.length + (procedures$ | async)?.length === 0 || showForm"
            [request]="request"
            [closable]="proposals.length > 0"
            (close)="showForm = false"
          ></app-technical-commercial-proposal-form>

          <ng-container *ngFor="let procedure of procedures$ | async; trackBy: trackById">
            <app-request-procedure [procedure]="procedure"
                                   [source]="'tcp'"
                                   (bargain)="procedureModalPayload = {action: 'bargain', procedure: procedure}"
                                   (prolong)="prolongModalPayload = procedure"
            ></app-request-procedure>
          </ng-container>
          <ng-container *ngFor="let proposal of proposals; trackBy: trackById">
            <app-request-technical-commercial-proposal
              [request]="request"
              [proposal]="proposal"
            ></app-request-technical-commercial-proposal>
          </ng-container>
        </div>

        <div class="app-col-aside detachable">
          <technical-commercial-proposal-filter></technical-commercial-proposal-filter>
        </div>
      </div>

      <!-- modals -->
      <uxg-modal size="l" [(state)]="procedureModalPayload" [ngSwitch]="procedureModalPayload?.action">
        <h2 *ngSwitchCase="'create'">Создание новой процедуры</h2>
        <h2 *ngSwitchCase="'bargain'">Уторговывание процедуры №{{procedureModalPayload?.procedure.procedureId}}</h2>
        <h2 *ngSwitchCase="'prolong'">Продление процедуры №{{procedureModalPayload?.procedure.procedureId}}</h2>
        <ng-container *ngIf="(availablePositions$ | async) as positions">
          <app-request-procedure-form
            *ngIf="procedureModalPayload"
            [request]="request"
            [positions]="positions"
            [action]="procedureModalPayload.action"
            [procedure]="procedureModalPayload.procedure"
            [procedureSource]="procedureSource"
            (complete)="this.store.dispatch(updateProcedures()); procedureModalPayload = null"
            (cancel)="procedureModalPayload = null"
          ></app-request-procedure-form>
        </ng-container>
      </uxg-modal>

      <uxg-modal #uploadTemplateModal size="l" (stateChange)="$event && (files = [])">
        <ng-container *ngIf="uploadTemplateModal.state">
          <h2 class="modal-title"><b>Загрузить технико-коммерческие предложения из шаблона</b></h2>
          <div class="app-secondary-color template">
            Вы можете загрузить ТКП списком, если заполните шаблон xls таблицы (<a class="app-link" (click)="store.dispatch(downloadTemplate(requestId))"><b>скачать
            шаблон</b></a>), и загрузите файл в систему. Если указать несколько поставщиков, то будет создано несколько ТКП.
          </div>
          <div class="dragAndDropArea">
            <app-template-upload
              [invalid]="invalidUploadTemplate"
              (fileSelected)="onChangeFilesList($event)"></app-template-upload>
          </div>
          <ng-template uxgModalFooter>
            <div class="doc-error-message" *ngIf="invalidUploadTemplate">Пожалуйста, загрузите необходимый шаблон</div>

            <button type="button" uxgButton secondary lg uxgModalClose (click)="invalidUploadTemplate = false">Отмена</button>
            <button uxgButton primary lg (click)="onSendTemplatePositions()">
              Загрузить
            </button>
          </ng-template>
        </ng-container>
      </uxg-modal>

      <uxg-modal [(state)]="addProposalPositionPayload">
        <h2>Добавить новое ТКП от {{addProposalPositionPayload?.proposal?.supplier.shortName}}</h2>
        <technical-commercial-proposal-position-form
          *ngIf="addProposalPositionPayload"
          [position]="addProposalPositionPayload.position"
          [proposal]="addProposalPositionPayload.proposal"
          (close)="addProposalPositionPayload = null"
        ></technical-commercial-proposal-position-form>
      </uxg-modal>

      <uxg-modal #addContragentModal size="s">
        <h2><b>Добавить столбик контрагента</b></h2>
        <technical-commercial-proposal-contragent-form
          *ngIf="addContragentModal.state"
          [request]="request"
          [selectedContragents]="getContragents(proposals)"
          (close)="addContragentModal.close()">
        </technical-commercial-proposal-contragent-form>
      </uxg-modal>

      <uxg-modal [(state)]="prolongModalPayload">
        <h2>Продление процедуры №{{prolongModalPayload?.procedureId}}</h2>
        <app-procedure-prolongate
          *ngIf="prolongModalPayload"
          [dateEndRegistration]="prolongModalPayload.dateEndRegistration"
          [dateSummingUp]="prolongModalPayload.dateSummingUp"
          [procedureId]="prolongModalPayload.procedureId"
          [requestId]="requestId"
          (close)="prolongModalPayload = null"
          (complete)="this.store.dispatch(updateProcedures()); prolongModalPayload = null"
        ></app-procedure-prolongate>
      </uxg-modal>

      <uxg-modal [(state)]="proposalModalData" size="l">
        <ng-container *ngIf="proposalModalData as modalData">
          <h2>{{ modalData.proposalPosition.position.name }}</h2>
          <app-proposal-detail
            [supplier]="modalData.proposal.supplier"
            [paymentTerms]="modalData.proposalPosition.paymentTerms"
            [manufacturingName]="modalData.proposalPosition.manufacturingName"
            [documents]="modalData.proposal.documents"
            [proposal]="modalData.proposalPosition"
            [position]="modalData.proposalPosition.position"
          ></app-proposal-detail>

          <ng-template uxgModalFooter>
            <div class="app-col app-bold">
              <div class="app-success-color" *ngIf="helper.isQuantityValid(modalData.proposalPosition)">- Позиция в нужном количестве</div>
              <div class="app-success-color" *ngIf="helper.isDateValid(modalData.proposalPosition)"> - Сроки укладываются в заданные</div>

              <div class="app-error-color" *ngIf="!helper.isQuantityValid(modalData.proposalPosition)">
                {{ helper.getRequestedQuantityLabel(modalData.proposalPosition) }}
              </div>
              <div class="app-error-color" *ngIf="!helper.isDateValid(modalData.proposalPosition)"> - Сроки не укладываются в заданные</div>
            </div>
            <button uxgButton lg secondary uxgModalClose>Закрыть</button>
          </ng-template>
        </ng-container>
      </uxg-modal>

    </ng-container>
  </ng-container>
</ng-container>

<ng-template #placeholder>
  <div class="app-row" [class.app-layout]="view !== 'list'">
    <div class="app-col">
      <div class="placeholder" *ngFor="let i of [].constructor(10)"></div>
    </div>
    <div class="app-col-aside detachable"></div>
  </div>
</ng-template>

<ng-container *ngIf="(request$ | async) as request; else placeholder">
  <ng-container *ngIf="(proposals$ | async) as proposals; else placeholder" [formGroup]="form">
    <!-- actions -->
    <div class="app-row">
      <div class="app-col">
        <div class="app-table app-no-border">
          <div class="app-row  app-align-items-center">
            <ng-container *ngIf="view==='grid'">
              <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions"></uxg-checkbox>
              <uxg-popover #selectPopover>
                <button uxgButton uxgPopoverTrigger link icon><clr-icon shape="app-triangle down"></clr-icon></button>
                <div *uxgPopoverContent>
                  <div><button uxgButton clear (click)="selectPopover.hide()">Все</button></div>
                  <div><button uxgButton clear (click)="selectPopover.hide()">Ни одного</button></div>
                </div>
              </uxg-popover>
            </ng-container>
            <div>
              <span class="app-secondary-color">показать: </span>
              <uxg-popover #viewPopover>
                <button uxgButton uxgPopoverTrigger link clear [ngSwitch]="view">
                 <span *ngSwitchCase="'grid'"><b>по позициям</b></span>
                 <span *ngSwitchCase="'list'"><b>по поставщикам</b></span>
                </button>
                <div *uxgPopoverContent>
                  <div><button uxgButton clear (click)="view='grid'; viewPopover.hide()">по позициям</button></div>
                  <div><button uxgButton clear (click)="view='list'; viewPopover.hide()">по поставщикам</button></div>
                </div>
              </uxg-popover>

            </div>
            <div class="app-col"></div>
            <div [ngSwitch]="view">

              <!-- Создать процедуру @TODO временно скрыто  -->
              <!--button uxgButton secondary iconText (click)="procedureModal.open()"
                      *ngIf="featureService.authorize('createProcedure')">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Создать процедуру</span>
              </button-->

              <!-- Новое ТКП  -->
              <button *ngSwitchCase="'list'" uxgButton secondary iconText (click)="showForm = true">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Новое ТКП</span>
              </button>

              <!-- Добавить столбец контрагента  -->
              <button *ngSwitchCase="'grid'" uxgButton secondary iconText (click)="showForm = true">
                <clr-icon shape="app-plus"></clr-icon>
                <span>Контрагент</span>
              </button>

              <!-- Новое ТКП шаблона -->
              <button uxgButton primary iconText (click)="uploadTemplateModal.open()">
                <clr-icon shape="app-plus"></clr-icon>
                <span>ТКП из шаблона</span>
              </button>

              <!-- Отправить на согласование -->
              <button *ngSwitchCase="'grid'" uxgButton primary>
                Отправить на согласование
              </button>
            </div>
          </div>
        </div>
      </div>
      <div @sidebarHide *ngIf="view==='list'" class="app-col app-col-aside"></div>
    </div>

    <!-- grid -->
    <div class="grid" *ngIf="view ==='grid'" [formGroup]="form">
      <!-- headers -->
      <div class="grid-row app-row contragents">
        <div class="app-col app-bold" *ngFor="let proposal of proposals">
          <app-contragent-info-link [contragent]="proposal.supplier"></app-contragent-info-link>
        </div>
      </div>

      <!-- items -->
      <div class="item" *ngFor="let item of proposalsByPositions$ | async; index as i" formArrayName="positions">
        <div class="app-row app-align-items-center app-section" [formGroupName]="i">
          <uxg-checkbox class="app-control" #checked formControlName="checked"></uxg-checkbox>
          <label (click)="checked.check($event)"><b>&nbsp; {{item.position.name}}</b></label>
        </div>
        <div class="grid-row app-row app-section">
          <ng-container *ngFor="let proposal of proposals">
            <div class="grid-item app-col" *ngIf="getProposalPosition(proposal, item.position) as proposalPosition; else addProposalPosition">
              <h3>
                {{(proposalPosition?.priceWithoutVat * proposalPosition?.quantity) | number:'1.0-2'}}
                <span class="app-ghost-color">{{getCurrencySymbol(proposalPosition.currency, "narrow")}}</span>
              </h3>
              <p>
                {{proposalPosition.quantity}} {{proposalPosition.measureUnit}} |
                {{proposalPosition.priceWithoutVat | number:'1.0-2'}}
                <span class="app-ghost-color">
                  {{getCurrencySymbol(proposalPosition.currency, "narrow")}}/{{proposalPosition.measureUnit}}
                </span>
              </p>
              <p class="app-ellipsis">
                {{ proposalPosition.manufacturingName }}
              </p>


              {{proposalPosition.deliveryDate | date:"dd.MM.yyyy"}}
            </div>
            <ng-template #addProposalPosition>
              <a class="grid-item app-col empty">
                <clr-icon shape="app-plus-big" size="24"></clr-icon>
              </a>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- list -->
    <div class="app-row" *ngIf="view==='list'">
      <div class="app-col app-technical-commercial-proposal-list">
        <app-technical-commercial-proposal-form
          *ngIf="(proposalsLength$ | async) === 0 || showForm"
          [request]="request"
          [closable]="proposals.length > 0"
          (close)="showForm = false"
        ></app-technical-commercial-proposal-form>

        <ng-container *ngFor="let proposal of proposals; trackBy: trackByProposalId">
          <app-request-technical-commercial-proposal
            [request]="request"
            [technicalCommercialProposal]="proposal"
          ></app-request-technical-commercial-proposal>
        </ng-container>
      </div>

      <div class="app-col-aside">
        <technical-commercial-proposal-filter></technical-commercial-proposal-filter>
      </div>
    </div>

    <!-- modals -->
    <clr-modal clrModalSize="lg" #procedureModal>
      <h2 class="modal-title">Создание новой процедуры</h2>
      <div class="modal-body" [style.overflow]="'visible'">
        <ng-container *ngIf="getPositions(proposals) as positions">
          <app-request-procedure-create
            *ngIf="procedureModal._open"
            [request]="request"
            [positions]="positions"
            [contragents]="getContragents(proposals)"
            [publicAccess]="false"
            (complete)="procedureModal.close()"
          ></app-request-procedure-create>
        </ng-container>
      </div>
    </clr-modal>
    <clr-modal #uploadTemplateModal [clrModalSize]="'lg'">
      <h2 class="modal-title"><b>Загрузить технико-коммерческие предложения из шаблона</b></h2>
      <div class="modal-body" *ngIf="uploadTemplateModal._open">
        <div class="app-secondary-color template">
          Вы можете загрузить ТКП списком, если заполните шаблон xls таблицы (<a (click)="store.dispatch(downloadTemplate(requestId))"><b>скачать
          шаблон</b></a>), и загрузите файл в систему. Если указать несколько поставщиков, то будет создано несколько ТКП.
        </div>
        <div class="dragAndDropArea">
          <app-template-upload (fileSelected)="files = $event"></app-template-upload>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" uxgButton secondary lg (click)="uploadTemplateModal.close()">Отмена</button>
        <button uxgButton primary lg (click)="store.dispatch(uploadTemplate(requestId, files)); uploadTemplateModal.close()"
                [disabled]="files.length === 0">
          Загрузить
        </button>
      </div>
    </clr-modal>
  </ng-container>
</ng-container>

<ng-template #placeholder>
  <div class="app-row">
    <div class="app-col">
      <div class="placeholder" *ngFor="let i of [].constructor(10)"></div>
    </div>
    <div class="app-col-aside"></div>
  </div>
</ng-template>

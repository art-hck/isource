<form [formGroup]="form" (ngSubmit)="submit(formPositions.controls)">
  <ng-container *ngIf="(positions$ | async) as positions; else loading">
    <div class="app-secondary-color">
      Выберите все необходимые позиции или группы позиций в заявке <b>№{{request.number}}</b>, по которым вы хотите
      создать техническое предложение от одного контрагента.
    </div>
    <br/>
    <br/>
    <div class="app-table app-no-border">
      <div class="app-row clr-align-items-center">
        <div class="app-col clr-flex-grow-0">
          <uxg-checkbox formControlName="checked" uxgSelectAllFor="positions"></uxg-checkbox>
        </div>
        <div class="app-col">
          <small><span class="app-secondary-color">Выбрано: </span><b>{{ checkedFormPositions.length }}</b></small>
        </div>
        <div class="app-col app-row clr-flex-grow-0 app-basis-auto clr-align-items-center">
          <div class="app-col app-ghost-color">
            <span>Фильтр: </span>
          </div>
          <div class="app-col" [style.width.px]="280">
            <input type="text" uxgInput formControlName="search" placeholder="Наименование позиции или группы"/>
          </div>
        </div>
      </div>
    </div>


    <hr/>
    <div class="app-table app-no-border">
      <ng-container *ngFor="let positionControl of formPositions.controls; index as i">
        <ng-container *ngIf="positionControl.value.position as position" formArrayName="positions">
          <ng-container *ngIf="isFiltered(position)">
            <div class="app-row" formGroupName="{{i}}">
              <div class="app-col clr-flex-grow-0">
                <uxg-checkbox formControlName="checked"></uxg-checkbox>
              </div>
              <div class="app-col app-bold item-title">{{ position.name }}</div>
              <div class="app-col item-quantity">
                <span>{{ position.quantity }} </span>
                <span class="app-ghost-color">{{ position.measureUnit | lowercase }}</span>
              </div>
              <div class="app-col item-date">
                <ng-container *ngIf="position.isDeliveryDateAsap; else deliveryDate">Как можно скорее</ng-container>
                <ng-template #deliveryDate>{{ position.deliveryDate | date : 'dd.MM.yyyy' }}</ng-template>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
    </div>
    <hr/>
    <br/>
    <div class="app-row clr-justify-content-end">
      <button type="button" uxgButton lg secondary (click)="cancel.emit()">Отмена</button>
      <button uxgButton lg primary [disabled]="form.invalid">Всё готово</button>
    </div>
  </ng-container>

  <ng-template #loading>
    <div class="text-center">
      <span class="spinner spinner-md"></span>
    </div>
  </ng-template>
</form>

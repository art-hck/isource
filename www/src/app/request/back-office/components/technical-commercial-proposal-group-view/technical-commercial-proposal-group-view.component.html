<div class="app-table app-no-border">
  <div class="app-row app-align-items-center">
    <div>
      <span class="app-secondary-color">показать: </span>
      <uxg-popover>
        <button uxgButton uxgPopoverTrigger link clear>
          <span><b>по предложениям</b></span>
        </button>
        <div *uxgPopoverContent>
          <div>
            <button uxgButton clear>по предложениям</button>
          </div>
        </div>
      </uxg-popover>
    </div>
    <div class="app-col"></div>
    <div>
      <!-- ТКП из процедуры  -->
      <button uxgButton secondary iconText (click)="procedureModalPayload = {action: 'create'}"
              *ngIf="featureService.authorize('createProcedure')">
        <uxg-icon shape="app-plus"></uxg-icon>
        <span>ТКП из процедуры</span>
      </button>

      <!-- Новая группа ТКП  -->
      <button uxgButton secondary iconText (click)="editedGroup = null; groupFormModal.open()">
        <uxg-icon shape="app-plus"></uxg-icon>
        <span>Новое ТКП</span>
      </button>

      <!-- ТКП из шаблона  -->
      <button uxgButton primary iconText (click)="form.reset(); uploadTemplateModal.open();">
        <uxg-icon shape="app-plus"></uxg-icon>
        <span>ТКП из шаблона</span>
      </button>
    </div>
  </div>
</div>

<div>
  <app-technical-commercial-proposal-group
    *ngFor="let group of tcpGroups$ | async"
    [technicalCommercialProposalGroup]="group"
    (edit)="editedGroup = group; groupFormModal.open()"
  ></app-technical-commercial-proposal-group>
</div>

<uxg-modal #groupFormModal size="l">
  <h2 *ngIf="!editedGroup">Создать новое ТКП</h2>
  <h2 *ngIf="editedGroup">Редактирование ТКП</h2>
  <app-technical-commercial-proposal-group-form
    *ngIf="groupFormModal.state"
    [group]="editedGroup"
    (cancel)="groupFormModal.close(); editedGroup = null" [requestId]="requestId"
    (create)="groupFormModal.close(); editedGroup = null; this.newGroup$.next($event);"
  >
  </app-technical-commercial-proposal-group-form>
</uxg-modal>

<uxg-modal #uploadTemplateModal size="l" (stateChange)="$event && (files = [])">
  <ng-container *ngIf="uploadTemplateModal.state">
    <h2 class="modal-title"><b>Загрузить технико-коммерческие предложения из шаблона</b></h2>
    <div class="app-secondary-color template">
      Вы можете создать ТКП списком, если заполните шаблон xls таблицы (<a class="app-link" (click)="store.dispatch(downloadTemplate(requestId))"><b>скачать
      шаблон</b></a>) и загрузите файл в систему. Если указать несколько поставщиков, то будет создано несколько ТКП.
    </div>

    <form appFormValidation [formGroup]="form">
      <div class="app-control-wrap">
        <input #name uxgInput lg formControlName="technicalCommercialProposalGroupName">
        <label class="app-control-label" (click)="name.focus()">Наименование ТКП</label>
        <div class="app-control-error" *ngIf="form.get('technicalCommercialProposalGroupName').errors as e">
          <span *ngIf="e.required">Обязательное поле</span>
        </div>
      </div>

      <div class="dragAndDropArea">
        <app-template-upload
          [invalid]="form.get('fileTemplate').dirty && form.get('fileTemplate').invalid"
          (fileSelected)="onChangeFilesList($event)"></app-template-upload>
      </div>

      <div class="app-modal-footer">
        <div class="doc-error-message" *ngIf="form.get('fileTemplate').dirty && form.get('fileTemplate').invalid">Пожалуйста, загрузите необходимый шаблон</div>

        <button type="button" uxgButton secondary lg uxgModalClose>Отмена</button>
        <button uxgButton primary lg (click)="submit()">Загрузить</button>
      </div>
    </form>
  </ng-container>
</uxg-modal>

<!-- ТКП из процедуры -->
<uxg-modal size="l" [(state)]="procedureModalPayload" [ngSwitch]="procedureModalPayload?.action">
  <h2 *ngSwitchCase="'create'">Создание новой процедуры</h2>
  <h2 *ngSwitchCase="'bargain'">Уторговывание процедуры №{{procedureModalPayload?.procedure.procedureId}}</h2>
  <h2 *ngSwitchCase="'prolong'">Продление процедуры №{{procedureModalPayload?.procedure.procedureId}}</h2>
  <ng-container *ngIf="(availablePositions$ | async) as positions">
    <app-request-procedure-form
      *ngIf="procedureModalPayload"
      [request]="(request$ | async)"
      [positions]="positions"
      [action]="procedureModalPayload.action"
      [procedure]="procedureModalPayload.procedure"
      [procedureSource]="procedureSource"
      (complete)="this.store.dispatch(updateProcedures()); updateTechnicalCommercialProposalGroups(); procedureModalPayload = null"
      (cancel)="procedureModalPayload = null"
    ></app-request-procedure-form>
  </ng-container>
</uxg-modal>

<form [formGroup]="form" (ngSubmit)="submit()">
  <div class="app-card">
    <!-- page title -->
    <div class="app-row">
      <div class="app-col">
        <h3 *ngIf="!technicalCommercialProposal">Новое технико-коммерческое предложение</h3>
        <h3 *ngIf="technicalCommercialProposal">Редактирование технико-коммерческого предложения</h3>
      </div>

      <div class="app-col clr-flex-grow-0" *ngIf="closable">
        <button type="button" uxgButton icon link (click)="close.emit()">
          <clr-icon shape="app-cross"></clr-icon>
        </button>
      </div>
    </div>

    <!-- supplier -->
    <div class="app-row clr-align-items-center">
      <div class="app-col">
        <div class="app-control-wrap">
          <uxg-dropdown-input
            formControlName="supplier" placeholder="Наименование контрагента" appSuggestions #sug="appSuggestions"
            [$]="contragents$" [lg]="true" [strictMode]="true" [displayByFn]="getContragentName" [searchFn]="searchContragent"
          >
            <ng-container *ngIf="(sug.suggestions$ | async) as contragents">
              <div uxgDropdownItem *ngFor="let contragent of contragents" [value]="contragent">
                {{contragent.shortName || contragent.fullName}}
                <span class="app-ghost-color">{{contragent.inn | splitNumber}}</span>
              </div>
            </ng-container>
            <ng-template #errors>
              <div class="app-control-error" *ngIf="form.get('supplier').errors as e">
                <span *ngIf="e.required">Обязательное поле</span>
                <span *ngIf="e.notFromList">Выберите контрагента из списка</span>
              </div>
            </ng-template>
          </uxg-dropdown-input>
        </div>
      </div>
      <div class="app-col app-secondary-color">
        Начните вводить наименование контрагента или его ИНН и система предложит вам варианты
      </div>
    </div>

    <hr/>

    <div class="app-col app-secondary-color section">
      Вы можете либо приложить необходимые документы, либо заполнить все заводсике наименования, либо приложить
      документы и заполнить все заводские наименования.
    </div>
    <div class="app-row section" *ngIf="form.get('positions') as control">
      <div class="app-col">
        <div class="app-row">
          <div class="app-col" [style.overflow]="'hidden'">
            <div class="title"><small class="app-uppercase app-ghost-color app-bold">Наименование позиции</small></div>
            <div>
              <button type="button" uxgButton secondary (click)="positionsModal.open()">Выбрать позиции</button>
            </div>
            <div *ngFor="let proposalPosition of control.value" class="app-ellipsis app-bold position-info-item">
              {{ proposalPosition.position.name }}
            </div>
          </div>
          <div class="app-col" [style.overflow]="'hidden'">
            <div class="title"><small class="app-uppercase app-ghost-color app-bold">Заводское наименование</small></div>
            <div>
              <button type="button" uxgButton secondary (click)="manufacturerModal.open()" [disabled]="!control.value?.length">
                Заполнить наименования
              </button>
            </div>
            <div *ngFor="let proposalPosition of control.value" class="app-ellipsis position-info-item">
              <ng-container *ngIf="proposalPosition.manufacturingName as name; else manufactureError">{{ name }}</ng-container>
              <ng-template #manufactureError>
                <ng-container *ngIf="manufacturerValidator(control, false) && control.hasError('manufacturer_name_error')">
                  <span class="app-error-color app-bold">Необходимо заполнить!</span>
                </ng-container>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
      <div class="app-col">
        <div class="app-row title">
          <div class="app-col"><small class="app-uppercase app-ghost-color app-bold">Cумма</small></div>
          <div class="app-col"><small class="app-uppercase app-ghost-color app-bold">Количество</small></div>
          <div class="app-col"><small class="app-uppercase app-ghost-color app-bold">Цена за ед.</small></div>
          <div class="app-col"><small class="app-uppercase app-ghost-color app-bold">Срок пост.</small></div>
        </div>
        <div>
          <button type="button" uxgButton secondary class="wide-button" (click)="parametersModal.open()"
                  [disabled]="!control.value?.length">
            Заполнить параметры
          </button>
        </div>

        <div class="position-info-item app-row" *ngFor="let pos of control.value">
          <ng-container *ngIf="pos.priceWithoutVat && pos.quantity && pos.measureUnit && pos.currency && pos.deliveryDate; else parameterError">
            <div class="app-col">
              {{ pos.quantity * pos.priceWithoutVat | number:'1.0-2' }}
              <span class="app-ghost-color">{{ getCurrencySymbol(pos.currency, "narrow")}}</span>
            </div>
            <div class="app-col">
              {{ pos.quantity }}
              <span class="app-ghost-color">{{ pos.measureUnit }}</span>
            </div>
            <div class="app-col">
              {{ pos.priceWithoutVat | number:'1.0-2' }}
              <span class="app-ghost-color">{{ getCurrencySymbol(pos.currency, "narrow")}}</span>
            </div>
            <div class="app-col">{{ pos.deliveryDate | date: "dd.MM.yyyy"}}</div>
          </ng-container>
          <ng-template #parameterError>
            <ng-container *ngIf="parametersValidator(control, false) && control.hasError('parameters_error')">
              <span class="app-error-color app-bold">Необходимо заполнить!</span>
            </ng-container>
          </ng-template>
        </div>


      </div>
    </div>

    <hr/>

    <div class="section">
      <proposal-form-documents
        formControlName="files"
        [documents]="technicalCommercialProposal?.documents || []"
      ></proposal-form-documents>
    </div>

    <hr/>

    <!-- footer -->
    <div class="app-row clr-align-items-center section">
      <div class="app-col app-secondary-color">
        Черновики технико-коммерческих предложений видны только сотрудникам бэкофиса, но не заказчику
      </div>
      <div class="app-row app-col clr-flex-grow-0 app-basis-auto clr-align-items-center">
        <span *ngIf="(status$ | async) ==='updating'" class="spinner spinner-inline">Загрузка...</span>
        <button
          type="button" uxgButton secondary (click)="submit(false)"
          [disabled]="form.disabled || form.invalid">Сохранить {{technicalCommercialProposal ? 'изменения' : 'черновик'}}
        </button>
        <button uxgButton primary [disabled]="form.disabled || form.invalid">Отправить на согласование</button>
      </div>
    </div>

    <!-- modals -->
    <clr-modal #positionsModal [clrModalSize]="'lg'">
      <h2 class="modal-title">Выбор позиций для технико-коммерческого предложения</h2>
      <div class="modal-body">
        <div class="app-secondary-color">
          Выберите все необходимые позиции или группы позиций в заявке <b>№{{request.number}}</b>, по которым вы хотите
          создать техническое предложение от одного контрагента.
        </div>
        <br/>
        <br/>
        <ng-container *ngIf="(availablePositions$ | async) as availablePositions">
          <select-items-with-search
            #positionsSelect
            placeholder="Наименование позиции или группы"
            formControlName="positions"
            class="select-list select-list-positions"
            [liveUpdate]="false"
            [items]="toProposalPosition(availablePositions)"
            (ngModelChange)="positionsModal.close()"
            [filterFn]="searchPosition"
            [trackBy]="trackByPositionId"
          >
            <ng-template let-formGroup="formGroup" let-positionWithMan="item">
              <div class="app-row" [formGroup]="formGroup" *ngIf="positionWithMan.position as position">
                <div class="app-col clr-flex-grow-0">
                  <uxg-checkbox formControlName="checked"></uxg-checkbox>
                </div>
                <div class="app-col app-bold app-ellipsis">{{ position.name }}</div>
                <div class="app-col select-list-item-quantity">
                  <span>{{ position.quantity }} </span>
                  <span class="app-ghost-color">{{ position.measureUnit | lowercase }}</span>
                </div>
                <div class="app-col select-list-item-date">
                  <ng-container *ngIf="position.isDeliveryDateAsap; else deliveryDate">Как можно скорее</ng-container>
                  <ng-template #deliveryDate>{{ position.deliveryDate | date : 'dd.MM.yyyy' }}</ng-template>
                </div>
              </div>
            </ng-template>
          </select-items-with-search>
          <br/>
          <div class="app-row clr-justify-content-end">
            <button type="button" uxgButton lg secondary (click)="positionsModal.close()">Отмена</button>
            <button uxgButton lg primary (click)="positionsSelect.submit()"
                    [disabled]="!positionsSelect.checkedFormItems.length">Всё готово</button>
          </div>
        </ng-container>
      </div>
    </clr-modal>
    <clr-modal #manufacturerModal [clrModalSize]="'lg'">
      <h2 class="modal-title">Заполнение заводских наименований</h2>
      <div class="modal-body">
        <app-request-proposal-form-manufacturer
          *ngIf="manufacturerModal._open"
          (cancel)="manufacturerModal.close()"
          (ngModelChange)="manufacturerModal.close()"
          formControlName="positions"
        ></app-request-proposal-form-manufacturer>
      </div>
    </clr-modal>

    <clr-modal #parametersModal [clrModalSize]="'lg'">
      <h2 class="modal-title">Параметры ТКП по позициям</h2>
      <div class="modal-body">
        <app-technical-commercial-proposal-parameters-form
          *ngIf="parametersModal._open"
          formControlName="positions"
          (ngModelChange)="parametersModal.close()"
          (cancel)="parametersModal.close()"
        ></app-technical-commercial-proposal-parameters-form>
      </div>
    </clr-modal>
  </div>
</form>

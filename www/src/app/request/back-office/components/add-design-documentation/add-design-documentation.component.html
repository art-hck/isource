<ng-container *ngIf="!request" class="load-block">
  <span class="spinner spinner-md"></span>
</ng-container>
<ng-container *ngIf="request">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a (click)="onRequestsClick()">Заявки</a> / <a (click)="onRequestClick()">Заявка №{{request.number}}</a>
        </div>
        <h2><b>Рабочая конструкторская документация</b></h2>
        <div class="clr-row w-100">
          <div class="clr-col-2">
            <span class="add-design-documentation" (click)="onShowDesignDocumentationListModal()">
              + Добавить перечень РКД
            </span>
          </div>
        </div>

        <!-- Модальное окно добавление перечня ркд -->
        <clr-modal [(clrModalOpen)]="showDesignDocumentationListModal"
                   [clrModalClosable]="false"
                   [clrModalSize]="'xl'">
          <h3 class="modal-title">Новый перечень РКД</h3>
          <div class="modal-body">
            <form [formGroup]="addDocumentationForm" class="form">
              <div formArrayName="addDocumentationListForm">
                <div class="clr-row w-100">
                  <div class="clr-col-5">
                    <label>Наименование документа</label>
                  </div>
                  <div class="clr-col-3">
                    <label>Срок предоставления (календ. дней)</label>
                  </div>
                  <div class="clr-col-3">
                    <label>Срок корректировки (календ. дней)</label>
                  </div>
                </div>
                <ng-container *ngFor="let item of addDocumentationListForm.controls; let i=index">
                  <div class="form-block">
                    <div class="clr-form-control">
                      <div class="clr-row w-100" formGroupName="{{i}}">
                        <div class="clr-col-5">
                          <input id="name" type="text" formControlName="name"
                                 [class.invalid]="isFieldInvalid(i, 'name')"/>
                        </div>
                        <div class="clr-col-3">
                          <input id="adjustmentLimit" type="number" formControlName="adjustmentLimit"
                                 [class.invalid]="isFieldInvalid(i, 'adjustmentLimit')"/>
                        </div>
                        <div class="clr-col-3">
                          <input id="receivingLimit" type="number" formControlName="receivingLimit"
                                 [class.invalid]="isFieldInvalid(i, 'receivingLimit')"/>
                        </div>
                        <div class="clr-col-1">
                          <button type="button" class="btn btn-link btn-danger btn-delete" (click)="deleteItem(i)"
                                  title="Удалить из списка" *ngIf="i > 0">
                            <clr-icon shape="times" size="18"></clr-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <button class="btn btn-link" (click)="onAddNext()" *ngIf="!addDocumentationForm.invalid">
                  Добавить документ
                </button>
              </div>
            </form>
            <div class="position-list">
              <div class="position-choice">
                <b>Выберите позиции:</b>
              </div>
              <div class="clr-row w-100" *ngFor="let position of getPositions()">
                <div class="clr-col-12">
                  <clr-checkbox-wrapper class="select-checkbox">
                    <input clrCheckbox type="checkbox"
                           value="{{ position }}"
                           [(ngModel)]="position.checked"
                           (change)="onSelectPosition(position)">
                    <label class="position-label nopadding">{{ position.name }}
                    </label>
                  </clr-checkbox-wrapper>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-link" (click)="onCloseAddDesignDocumentationModal()">Отмена</button>
            <button class="btn btn-primary" (click)="onAddDesignDocumentationList()"
                    [disabled]="addDocumentationForm.invalid || selectedPositions.length === 0">
              Добавить
            </button>
          </div>
        </clr-modal>

        <div class="design-documentation-card-list" *ngFor="let designDocumentation of designDocumentations">
          <div class="design-documentation-card">
            <div class="clr-row clr-align-items-center">
              <span class="position-name clr-col">
                <span>{{designDocumentation.position.name}}</span>
              </span>
              <table class="document-list table table-noborder">
                <thead>
                <tr class="clr-row">
                  <th class="left clr-col-3" [class.clr-col-12]="!isRkdAgreementStatus(designDocumentation)">
                    Наименование документа
                  </th>
                  <ng-container *ngIf="isRkdAgreementStatus(designDocumentation)">
                    <th class="left clr-col-3">Документ</th>
                    <th class="left clr-col-2">Дата предоставления</th>
                    <th class="left clr-col-2">Дата рассмотрения</th>
                    <th class="left clr-col-2">Дата корректировки</th>
                  </ng-container>
                </tr>
                </thead>
                <tbody>
                <tr class="clr-row" *ngFor="let designDoc of designDocumentation.designDocs">
                  <td class="left clr-col-3" [class.clr-col-12]="!isRkdAgreementStatus(designDocumentation)">
                    {{designDoc.name}}
                  </td>
                  <ng-container *ngIf="isRkdAgreementStatus(designDocumentation)">
                    <td class="left clr-col-3">
                      <div class="form-group compact">
                        <app-document-simple-list
                          [documents]="designDoc.documents"
                          [enableUpload]="canUploadDocuments(designDoc, designDocumentation)"
                          [limit]="5"
                          (selected)="onSelectDocument($event, designDoc)"
                        ></app-document-simple-list>
                        <label class="document-loading" *ngIf="isLoadingDesignDoc(designDoc)">Загрузка...</label>
                      </div>
                    </td>
                    <td class="left date clr-col-2">
                      {{designDoc.receivingDate | date :'shortDate'}}
                    </td>
                    <td class="left date clr-col-2">
                      {{designDoc.reviewDate | date :'shortDate'}}
                    </td>
                    <td class="left date clr-col-2">
                      {{designDoc.adjustmentDate | date :'shortDate'}}
                    </td>
                  </ng-container>
                </tr>
                </tbody>
              </table>
              <div class="document-status">
                <button class="btn" *ngIf="designDocumentation.status as status"
                        [ngSwitch]="status"
                        [ngClass]='{
                            "btn-primary": status === designDocStatus.NEW && !this.isSendingForApproval(designDocumentation),
                            "btn-info-outline": status === designDocStatus.ON_APPROVAL || this.isSendingForApproval(designDocumentation),
                            "btn-success-outline": status === designDocStatus.APPROVAL,
                            "btn-danger-outline": status === designDocStatus.REJECTED,
                            "btn-label": status !== designDocStatus.NEW
                          }'
                        [clrLoading]="this.isSendingForApproval(designDocumentation) ? clrLoadingState.LOADING : clrLoadingState.DEFAULT"
                        [disabled]="!isApprovable(designDocumentation) || status === designDocStatus.ON_APPROVAL"
                        (click)="sendForApproval(designDocumentation)">
                  <span *ngSwitchCase="designDocStatus.NEW">Согласовать</span>
                  <span *ngSwitchCase="designDocStatus.ON_APPROVAL">На согласовании</span>
                  <span *ngSwitchCase="designDocStatus.APPROVAL">Согласовано</span>
                  <span *ngSwitchCase="designDocStatus.REJECTED">Отклонено</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<ng-container *ngIf="!request" class="load-block">
  <span class="spinner spinner-md"></span>
</ng-container>

<ng-container *ngIf="request">
  <div class="clr-row">
    <div class="info-card clr-col">
      <div class="request-info">
        <div class="breadcrumbs">
          <a (click)="onRequestsClick()">Заявки</a> / <a (click)="onRequestClick()">Заявка №{{request.number}}</a>
        </div>
        <h2>Технические предложения</h2>

        <div class="clr-row w-100">
          <div class="clr-col-2">
            <span class="add-technical-proposal" (click)="onShowAddTechnicalProposalModal()">
              + Добавить ТП
            </span>
          </div>
        </div>

        <div class="technical-proposal-card-list">
          <div  class="technical-proposal-card" *ngFor="let technicalProposal of technicalProposals; let i = index">
            <div class="clr-row clr-align-items-center">
              <span class="supplier-name clr-col">
                <span>{{ technicalProposal.name }}</span>
                <div class="edit-btn" (click)="onShowEditTechnicalProposalModal(technicalProposal)">
                  <clr-icon shape="pencil"></clr-icon>
                </div>
              </span>



              <div class="clr-col send-for-approval">
                <div *ngIf="technicalProposal.status === 'false'; else sentForReview">
                  <button class="btn btn-primary"
                          [class.disabled]="!isReadyToSendForApproval(technicalProposal)"
                          (click)="onSendForApproval(technicalProposal)">
                    <b>Отправить на согласование</b>
                  </button>

                  <p>{{ technicalProposal.status }}</p>
                </div>

                <ng-template #sentForReview>
                  <p class="sent-label">Отправлено на согласование</p>
                  <p>{{ technicalProposal.status }}</p>
                </ng-template>
              </div>
            </div>

            <div>
              <app-document-simple-list
                      [documents]="technicalProposal.documents"
                      [enableUpload]="false"
              ></app-document-simple-list>
            </div>

            <table class="positions-list table table-noborder">
              <thead>
                <tr>
                  <th class="left">Наименование позиции</th>
                  <th class="left">Заводское наименование</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let technicalProposalPosition of technicalProposal.positions">
                  <td class="left">{{ technicalProposalPosition.position.name }}</td>
                  <td class="left">
                    <div class="form-group compact">
                      <input type="text"
                             placeholder="Наименование не заполнено.."
                             (change)="updateTpPositionManufacturingName(
                               technicalProposalPosition,
                               technicalProposal.id,
                               $event.target.value
                             )"
                             value="{{ technicalProposalPosition.manufacturingName }}" />
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <clr-modal *ngIf="technicalProposal" [(clrModalOpen)]="showAddTechnicalProposalModal">
    <h3 class="modal-title">{{
        tpModalInEditMode(technicalProposal) ?
        "Редактирование технического предложения" :
        "Новое техническое предложение"
      }}</h3>

    <div class="modal-body">

      <div class="clr-row w-100">
        <div class="clr-col-12">
          <label for="supplierName">
            <span class="supplier-name-label">Наименование поставщика</span>
          </label>
          <input type="text"
                 id="supplierName"
                 name="supplierName"
                 [(ngModel)]="tpSupplierName"
                 value="{{ technicalProposal.name }}">
        </div>

        <div class="clr-col-12">
          <div *ngIf="!tpModalInEditMode(technicalProposal); else editUploadedDocsBlock">
            <form [formGroup]="documentsForm" class="form tp-documents-list">
              <app-document-upload-list
                  (fileSelected)="onDocumentSelected($event, documentsForm)"
                  [documents]="uploadedFiles"
              ></app-document-upload-list>
            </form>
          </div>

          <ng-template #editUploadedDocsBlock>
            <form [formGroup]="documentsForm" class="form tp-documents-list">
              <app-document-simple-list
                  [documents]="technicalProposal.documents"
                  [enableUpload]="false"
              ></app-document-simple-list>

              <app-document-upload-list
                      (fileSelected)="onDocumentSelected($event, documentsForm)"
                      [documents]="uploadedFiles"
              ></app-document-upload-list>
            </form>
          </ng-template>
        </div>
      </div>

      <div class="clr-row w-100 clr-align-items-center">
        <div class="clr-col-12">
          <span class="positions-list-label">Позиции технического предложения:</span>
        </div>

        <div class="clr-col-12">
          <div class="card-block" style="padding: 10px 0 15px 0">

            <ng-container *ngIf="!(technicalProposalsPositions && technicalProposalsPositions.length > 0)" class="load-block">
              <span class="spinner spinner-md"></span>
            </ng-container>

            <ng-container *ngFor="let technicalProposalPosition of technicalProposalsPositions">
              <clr-checkbox-wrapper class="tp-positions-list">
                <input type="checkbox"
                       clrCheckbox
                       value="{{ technicalProposalPosition.id }}"
                       (change)="onTechnicalProposalPositionSelected(technicalProposalPosition)"
                       [checked]="checkIfPositionIsChecked(technicalProposalPosition)" />
                <label>{{ technicalProposalPosition.name }}</label>
              </clr-checkbox-wrapper>
            </ng-container>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-footer">
      <div class="clr-row w-100">
        <div class="clr-col-12 text-right">
          <button class="btn btn-link" (click)="showAddTechnicalProposalModal = false">Отмена</button>

          <ng-container *ngIf="!tpModalInEditMode(technicalProposal); else saveBtn">
            <button class="btn btn-primary"
                    [disabled]="!selectedTechnicalProposalPositionsIds.length > 0 || !tpSupplierName?.trim()"
                    (click)="onAddTechnicalProposal()">Добавить</button>
          </ng-container>

          <ng-template #saveBtn>
            <button class="btn btn-primary"
                    [disabled]="!selectedTechnicalProposalPositionsIds.length > 0 || !tpSupplierName?.trim()"
                    (click)="onSaveTechnicalProposal()">Сохранить</button>
          </ng-template>
        </div>
      </div>
    </div>
  </clr-modal>


</ng-container>

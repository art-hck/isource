<div class="app-card">
  <!-- title -->
  <div class="app-row app-align-items-center">
    <h3 class="app-col">{{position.sourcePosition.name}}</h3>

    <div class="app-ghost-color app-bold" *ngIf="!isReviewed && !isSentToEdit">
      <uxg-icon shape="app-waiting"></uxg-icon>
      <span>Необходимо рассмотреть</span>
    </div>

    <div class="app-warning-color app-bold" *ngIf="isSentToEdit">
      <uxg-icon shape="app-warning"></uxg-icon>
      <span>На доработке</span>
    </div>

    <div class="app-success-color app-bold" *ngIf="isReviewed">
      <uxg-icon shape="app-check"></uxg-icon>
      <span>Выбран победитель</span>
    </div>

    <button uxgButton icon link (click)="folded = !folded">
      <uxg-icon shape="app-chevron" [attr.dir]="folded ? 'down' : 'up'"></uxg-icon>
    </button>
  </div>

  <ng-container *ngIf="!folded">
    <div class="grid" [class.on-review]="!isReviewed && !isSentToEdit">
      <hr/>
      <div class="app-row data data-head app-uppercase app-ghost-color app-bold section">
        <div class="app-col app-ellipsis supplier"><small>Поставщик</small></div>
        <div class="app-col app-ellipsis quantity"><small>Количество</small></div>
        <div class="app-col app-ellipsis price"><small>Цена за ед. без НДС</small></div>
        <div class="app-col app-ellipsis date"><small>Срок пост.</small></div>
        <div class="app-col app-ellipsis total"><small>Сумма без НДС</small></div>
        <div *ngIf="!isReviewed && !isSentToEdit" class="app-col radio"></div>
        <div *ngIf="isReviewed || isSentToEdit" class="app-col status"><small class="app-uppercase app-ghost-color">Статус</small></div>
      </div>

      <div class="data-body-container" *ngFor="let proposal of proposals; index as i; trackBy: trackByProposalId;">
        <div (click)="show.emit(proposal)" class="app-row app-link-no-color data data-body">
          <div class="app-col  app-ellipsis supplier">
            <app-contragent-info-link
              hiddenName="Поставщик №{{i + 1}}"
              [contragent]="proposal.sourceProposal.supplierContragent"
              (click)="$event.stopPropagation()"
            ></app-contragent-info-link>
          </div>

          <div class="app-col quantity">
            <div [ngClass]="!helper.isQuantityValid(position, proposal) ? 'app-error-color app-bold' : ''">
              <div class="app-row app-align-items-center">
                <span>{{proposal.quantity}} <span class="app-ghost-color">{{proposal.measureUnit}}</span></span>
                <uxg-icon shape="app-narrow-arrow"
                          *ngIf="proposal.quantity != position.quantity"
                          [attr.dir]="proposal.quantity > position.quantity ? 'up' : 'down'"></uxg-icon>
              </div>
            </div>
          </div>

          <div class="app-col price">
            {{proposal.priceWithoutVat | number:'1.0-2'}}
            <span class="app-ghost-color">{{getCurrencySymbol(proposal.currency, "narrow")}}</span>
          </div>

          <div class="app-col date">
            <span [ngClass]="!helper.isDateValid(position, proposal) ? 'app-error-color app-bold' : ''">
              {{proposal.deliveryDate | date:"dd.MM.yyyy"}}
            </span>
          </div>

          <div class="app-col total">
            {{proposal.priceWithoutVat * proposal.quantity | number:'1.0-2'}}
            <span class="app-ghost-color">{{getCurrencySymbol(proposal.currency, "narrow")}}</span>
          </div>

          <div class="app-col radio" *ngIf="!isReviewed && !isSentToEdit">
            <uxg-radio-item
              [name]="position.id"
              [value]="proposal.sourceProposal"
              [formControl]="selectedProposal"
              (click)="$event.stopPropagation()"
            ></uxg-radio-item>
          </div>

          <div class="app-col status" *ngIf="isReviewed || isSentToEdit">
            <ng-container *ngIf="isSentToEdit">
              <uxg-icon shape="app-warning" class="app-warning-color"></uxg-icon>
            </ng-container>

            <ng-container *ngIf="isReviewed">
              <uxg-icon shape="app-check" [ngClass]="{
                'app-success-color': proposal.isWinner,
                'app-ghost-color': !proposal.isWinner
              }"></uxg-icon>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <ng-container *ngIf="!isReviewed && !isSentToEdit">
      <hr/>
      <div class="app-row">
        <div class="app-col">
          <!-- @TODO: Ждем реализацию на бэкенде -->
          <!-- Вы можете отклонить все предложения по этой позиции и не получать другие предложения по ней от этих поставщиков -->
        </div>
        <div>
          <!-- @TODO: Ждем реализацию на бэкенде -->
          <!--<button uxgButton secondary [disabled]="selectedProposalPosition.disabled" (click)="reject()">
            Отклонить все по позиции
          </button>-->
          <button uxgButton secondary [disabled]="sendToEditPosition.disabled" (click)="sendToEdit()">
            Всё на доработку
          </button>

          <button uxgButton primary [disabled]="selectedProposal.invalid || selectedProposal.disabled" (click)="approve()">
            Согласовать
          </button>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>

<ng-container *ngIf="request$ | async"></ng-container>
<ng-container *ngIf="(stateStatus$ | async) !== 'fetching'; else placeholder">
  <div class="app-row">
    <div class="app-col">
      <div class="app-row app-align-items-center" [class.app-layout]="view === 'grid'">

        <uxg-tabs class="app-col">
          <uxg-tab-title #sentToReviewTab [disabled]="(proposalsSentToReview$ | async).length === 0" [active]="true">
            <ng-container *ngIf="(proposalsSentToReview$ | async) as proposals">
              Необходимо рассмотреть <span class="counter">({{proposals?.length}})</span>
            </ng-container>
          </uxg-tab-title>

          <uxg-tab-title #sendToEditTab [disabled]="(proposalsSendToEdit$ | async).length === 0">
            <ng-container *ngIf="(proposalsSendToEdit$ | async) as proposals">
              На доработке <span class="counter">({{ proposals?.length }})</span>
            </ng-container>
          </uxg-tab-title>

          <uxg-tab-title #reviewedTab [disabled]="(proposalsReviewed$ | async).length === 0">
            <ng-container *ngIf="(proposalsReviewed$ | async) as proposals">
              Рассмотренные <span class="counter">({{ proposals?.length }})</span>
            </ng-container>
          </uxg-tab-title>
        </uxg-tabs>

        <ng-container *ngIf="(proposals$ | async).length">
          <div class="app-secondary-color">Режим отображения:</div>
          <div class="app-btn-group">
<!--            <button uxgButton [primary]="view==='simple-grid'" [secondary]="view!=='simple-grid'" icon (click)="switchView('simple-grid')">-->
<!--              <uxg-icon shape="app-simple-grid-view"></uxg-icon>-->
<!--            </button>-->
            <button uxgButton [primary]="view==='grid'" [secondary]="view!=='grid'" icon (click)="switchView('grid')">
              <uxg-icon shape="app-grid-view"></uxg-icon>
            </button>
            <button uxgButton [primary]="view==='list'" [secondary]="view!=='list'" icon (click)="switchView('list')">
              <uxg-icon shape="app-list-view"></uxg-icon>
            </button>
          </div>
          <!--  <button uxgButton secondary>Фильтр</button> -->
        </ng-container>
      </div>

      <br/>

      <ng-container [ngSwitch]="view" *ngIf="(reviewedTab.active ? proposalsReviewed$ : sentToReviewTab.active ? proposalsSentToReview$ : proposalsSendToEdit$) | async as proposalsByPos">
        <div #gridTable *ngIf="view !== 'list'" [ngClass]="{
          'grid-table': view === 'grid',
          'simple-grid-table': view === 'simple-grid',
          'disabled': (stateStatus$ | async) === 'updating'}"
        >
          <app-grid-contragents
            *ngIf="proposalsByPos.length && view === 'grid'"
            [gridRows]="gridRows"
            [suppliers]="suppliers(proposals$ | async)"
            [positionCell]="true"
            [showParams]="true"
            [proposals]="proposals$ | async"
            [proposalsByPos]="proposalsSentToReview$ | async"
            (openCommonParams)="gridTable.scrollIntoView({behavior: 'smooth'})"
            (selectProposalBySupplier) = selectSupplierProposal($event)
          ></app-grid-contragents>
          <ng-container *ngFor="let proposalByPos of proposalsByPos">
            <app-grid-row
              #proposalOnReview
              [chooseBy$]="chooseBy$"
              [position]="proposalByPos.position"
              [simpleView]="view === 'simple-grid'"
              [suppliers]="suppliers(proposals$ | async)"
              [proposals]="converProposalPosition(proposalByPos)"
              [isReviewed]="isReviewed(proposalByPos)"
              [getProposal]="getProposalBySupplier(proposalByPos)"
              (show)="modalData = {proposal: $event, supplier: getSupplierByProposal(proposalByPos, $event),  position: converPosition(proposalByPos.position)}"
            >
              <ng-template #position>
                <div class="grid-cell app-col">
                  <div class="app-row app-flex-column">
                    <div><b>{{ proposalByPos.position.name }}</b></div>

                    <div class="app-secondary-color">
                      <span>{{proposalByPos.position.quantity}}</span>
                      <span class="app-ghost-color">{{proposalByPos.position.measureUnit}}</span>
                      <span class="app-ghost-color"> | </span>
                      <span *ngIf="proposalByPos.position.isDeliveryDateAsap; else deliveryDate">как можно скорее</span>
                      <ng-template #deliveryDate><span>{{proposalByPos.position.deliveryDate | date:"dd.MM.yyyy"}}</span></ng-template>
                    </div>
                    <div class="app-col"></div>

                    <div class="app-row app-align-items-center" *ngIf="!isReviewed(proposalByPos)">
                      <uxg-radio-item
                        class="app-control"
                        #sendToEditRadio
                        [name]="proposalByPos.position.id"
                        [value]="proposalByPos.position"
                        [formControl]="proposalOnReview.sendToEditPosition"
                        (click)="$event.stopPropagation()"
                      ></uxg-radio-item>
                      <label (click)="sendToEditRadio.select($event)">&nbsp; Все на доработку</label>
                    </div>
                    <div class="app-success-color app-bold" *ngIf="hasWinner(proposalByPos)">
                      <uxg-icon shape="app-check"></uxg-icon>
                      <span>Выбран победитель</span>
                    </div>
                    <div class="app-warning-color app-bold" *ngIf="isSentToEdit(proposalByPos)">
                      <uxg-icon shape="app-warning"></uxg-icon>
                      <span>На доработке</span>
                    </div>
                  </div>
                </div>
              </ng-template>
            </app-grid-row>
          </ng-container>
        </div>

        <!-- list -->
        <ng-container *ngSwitchCase="'list'">
          <ng-container *ngIf="(reviewedTab.active ?
            reviewedProposals :
            sentToReviewTab.active ?
                sentToReviewProposals :
                sentToEditProposals) as proposals">
            <app-request-technical-commercial-proposal #tcpComponent
              *ngFor="let proposal of proposals; let i = index; trackBy: trackById"
              [technicalCommercialProposalIndex]="i"
              [chooseBy$]="chooseBy$"
              [proposal]="proposal"
              [proposals]="proposals"
              [isLoading]="isLoading"
              (positionSelected)="onPositionSelected($event)">
            </app-request-technical-commercial-proposal>
          </ng-container>
        </ng-container>

        <!-- empty -->
        <div *ngIf="proposalsByPos.length === 0">
          <h1 class="text-center" [style.opacity]="0.1">
            <br/>
            <uxg-icon shape="app-publish" size="270"></uxg-icon><br/>
            Все технико-коммерческие предложения рассмотрены
          </h1>
        </div>
      </ng-container>
    </div>
    <div class="app-col-aside detachable" *ngIf="view==='list'"></div>
  </div>
</ng-container>

<app-grid-footer
  [disabled]="(stateStatus$ | async) !== 'received' || disabled"
  [loading]="(stateStatus$ | async) !== 'received'"
  (approve)="reviewMultiple()"
  (sendToEdit)="sendToEditAll()"
  (approveFromListView)="approveFromListView()"
  (sendToEditFromListView)="sendToEditFromListView()"
  (confirmApproveFromList)="openConfirmApproveFromListModal()"
  [chooseBy$]="chooseBy$"
  [hidden]="view === 'grid' && (!sentToReviewTabElRef?.active || proposalsOnReview?.length === 0)"
  [viewType]="view"
  [total]="total"
  [selectedPositions]="selectedPositions"
  [selectedProposals]="allSelectedProposals"
  [source]="'tcp'"
></app-grid-footer>

<ng-template #placeholder>
  <div class="app-row" [class.app-layout]="view === 'grid'">
    <div class="app-col">
      <div class="app-row">
        <div class="app-col app-row">
          <div class="placeholder-row" *ngFor="let i of [].constructor(2)" [style.height.px]="40" [style.width.px]="200"></div>
        </div>
        <div class="placeholder-row" [style.height.px]="40" [style.width.px]="80"></div>
      </div>

      <div class="placeholder" *ngFor="let i of [].constructor(10)" [style.height.px]="160"></div>
    </div>
    <div class="app-col-aside detachable"></div>
  </div>
</ng-template>

<uxg-modal [(state)]="modalData" size="l">
  <ng-container *ngIf="modalData">
    <h2>{{ modalData.position.sourcePosition.name }}</h2>
    <app-proposal-detail
      [supplier]="modalData.supplier"
      [paymentTerms]="modalData.proposal.sourceProposal.paymentTerms"
      [manufacturingName]="modalData.proposal.manufacturingName"
      [documents]="[]"
      [manufacturer]="modalData.proposal.sourceProposal.manufacturer"
      [standard]="modalData.proposal.sourceProposal.standard"
      [proposal]="modalData.proposal"
      [position]="modalData.position"
    ></app-proposal-detail>

    <ng-template uxgModalFooter>
      <div class="app-col app-bold">
        <div class="app-success-color" *ngIf="helper.isQuantityValid(modalData.position, modalData.proposal)">- Позиция в нужном количестве</div>
        <div class="app-success-color" *ngIf="helper.isDateValid(modalData.position, modalData.proposal)"> - Сроки укладываются в заданные</div>

        <div class="app-error-color" *ngIf="!helper.isQuantityValid(modalData.position, modalData.proposal)">
          {{ helper.getRequestedQuantityLabel(modalData.position, modalData.proposal) }}
        </div>
        <div class="app-error-color" *ngIf="!helper.isDateValid(modalData.position, modalData.proposal)"> - Сроки не укладываются в заданные</div>
      </div>

      <div *ngIf="!['APPROVED', 'REJECTED', 'SENT_TO_EDIT'].includes(modalData.proposal.sourceProposal.status)">
        <button uxgButton lg secondary uxgModalClose>Отмена</button>
        <button uxgButton lg primary (click)="selectProposal(modalData.proposal); modalData = null">Выбрать</button>
      </div>
      <div *ngIf="['APPROVED', 'REJECTED', 'SENT_TO_EDIT'].includes(modalData.proposal.sourceProposal.status)">
        <button uxgButton lg secondary uxgModalClose>Закрыть</button>
      </div>
    </ng-template>
  </ng-container>
</uxg-modal>

<uxg-modal #selectedProposalsApprovalModal [(state)]="approvalModalData" size="l">
  <ng-container *ngIf="approvalModalData">
    <h2>Подтверждение результатов выбора</h2>

    <div class="list-header-row app-row app-align-items-center">
      <div class="app-col">
        <div class="selected-counters">
          <span class="counter"><span class="app-ghost-color">Всего позиций: </span>{{ approvalModalData.counters.totalCounter }}</span>
          <span class="counter"><span class="app-ghost-color">Победителей: </span>{{ approvalModalData.counters.toApproveCounter }}</span>
          <span class="counter"><span class="app-ghost-color">На доработку: </span>{{ approvalModalData.counters.sendToEditCounter }}</span>
        </div>
      </div>

      <div class="app-col app-col-auto app-row app-align-items-center">
        <div class="app-col app-col-auto app-ghost-color">Фильтр: &nbsp; </div>
        <div class="app-col-auto search">
          <input type="text" uxgInput (input)="filterQuery = $event.target.value" [placeholder]="'Наименование позиции или группы'" />
        </div>
      </div>
    </div>

    <hr>

    <div class="app-table app-no-border scroll-area">
      <ng-container *ngFor="let proposalPositionsBlock of approvalModalData.selectedProposals">
        <div class="supplier-block" [hidden]="allPositionsFiltered(proposalPositionsBlock)">
          <div class="app-row app-justify-content-between short-name">
            <div class="app-col app-col-auto">
              <h3>{{ proposalPositionsBlock.supplier.shortName }}</h3>
            </div>

            <div class="app-col app-col-auto sum-by-supplier">
              <span class="app-ghost-color">Сумма по поставщику: </span>
              <span class="app-bold">{{ getSelectedProposalsSumBySupplier(proposalPositionsBlock.toApprove) | number: "1.0-2" }}
                <span class="app-ghost-color">{{ getCurrencySymbol('RUB', 'narrow') }}</span>
              </span>
            </div>
          </div>

          <div class="positions-list">
            <div class="to-approve">
              <ng-container *ngFor="let toApproveProposalPosition of proposalPositionsBlock.toApprove">
                <div class="app-row select-list-item" *ngIf="!positionIsFiltered(toApproveProposalPosition)">
                  <div class="app-col app-bold select-list-item-title">{{ toApproveProposalPosition.manufacturingName }}</div>

                  <div class="app-col app-col-auto select-list-item-quantity">
                    <span>{{ toApproveProposalPosition.quantity }} </span>
                    <span class="app-ghost-color">{{ toApproveProposalPosition.measureUnit | lowercase }}</span>
                  </div>

                  <div class="app-col app-col-auto select-list-item-total-price">
                    <ng-container *ngIf="toApproveProposalPosition.priceWithoutVat; else withoutTotalPrice">
                      {{ toApproveProposalPosition.priceWithoutVat * toApproveProposalPosition.quantity | number: "1.0-2" }}
                      <span class="app-ghost-color">{{ getCurrencySymbol(toApproveProposalPosition.currency, 'narrow') }}</span>
                    </ng-container>

                    <ng-template #withoutTotalPrice>
                      <span class="app-ghost-color">не указана</span>
                    </ng-template>
                  </div>

                  <div class="app-col select-list-item-supplier-name">
                    <span>{{ proposalPositionsBlock.supplier.shortName }}</span>
                  </div>

                  <div class="app-col app-col-auto app-success-color select-list-item-icon">
                    <uxg-icon shape="app-check"></uxg-icon>
                  </div>
                </div>
              </ng-container>
            </div>

            <div class="to-send-to-edit">
              <div class="app-row select-list-item" *ngFor="let toSendToEditProposalPosition of proposalPositionsBlock.toSendToEdit">
                <div class="app-col app-bold select-list-item-title">{{ toSendToEditProposalPosition.manufacturingName }}</div>

                <div class="app-col select-list-item-supplier-name">
                  <span class="app-ghost-color">На доработку</span>
                </div>

                <div class="app-col app-col-auto app-warning-color select-list-item-icon">
                  <uxg-icon shape="app-warning"></uxg-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <hr>

    <div class="app-row select-list-item-footer app-uppercase app-ghost-color app-bold">
      <div class="app-col app-bold select-list-item-title"></div>
      <div class="app-col app-bold app-col-auto select-list-item-quantity">Кол-во</div>
      <div class="app-col app-col-auto select-list-item-total-price">Сумма</div>
      <div class="app-col select-list-item-supplier-name">Победитель/статус</div>
    </div>

    <br/>

    <div class="app-row app-justify-content-end">
      <div class="app-col">
        <h3 class="total-sum">
          <span class="app-ghost-color app-font-normal">Общая сумма:</span> {{ getSelectedProposalsTotalSum(approvalModalData.selectedProposals) | number: "1.0-2" }}
          <span class="app-ghost-color">{{ getCurrencySymbol('RUB', 'narrow') }}</span>
        </h3>
      </div>

      <div class="app-row app-col app-col-auto app-align-items-center">
        <span *ngIf="isLoading" class="spinner spinner-inline"></span>
        <button type="button" uxgButton secondary lg (click)="selectedProposalsApprovalModal.close()">Отмена</button>
        <button uxgButton primary lg (click)="reviewMultiple(); selectedProposalsApprovalModal.close()">Подтвердить выбор</button>
      </div>
    </div>
  </ng-container>
</uxg-modal>

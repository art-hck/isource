stages:
  - build
  - codestyle
  - e2e

build staging:
  stage: build
  tags:
    - gpn-test-front
  script:
    - pwd | xargs /bin/bash /var/agent/front/01.sync.sh
    - /bin/bash /var/agent/front/02.npm_install.sh
    - /bin/bash /var/agent/front/03.ng_build_prod.sh
    - /bin/bash /var/agent/front/04.change_girs.sh
    - exit 0
  only:
    - dev

codestyle staging:
  stage: codestyle
  tags:
    - gpn-test-front
  script:
    - cd www
    - npm i tslint --no-optional
    - npm run tslint
    - exit 0
  only:
    - merge_requests

e2e preprod:
  stage: e2e
  tags:
    - gpn-test-front
  script:
    - docker-compose -f dc-e2e-release.yml build --no-cache
    - docker-compose -f dc-e2e-release.yml up -d
    - docker exec -i angular-release bash -c "envsubst < e2e/protractor.conf.js.dist > e2e/protractor.conf.js"
    - docker exec -i angular-release ng e2e --port 4202
  only:
    - /^release-.*$/
  when: manual

e2e prod:
  stage: e2e
  tags:
    - gpn-test-front
  script:
    - docker-compose -f dc-e2e-master.yml build --no-cache
    - docker-compose -f dc-e2e-master.yml up -d
    - docker exec -i angular-master bash -c "envsubst < e2e/protractor.conf.js.dist > e2e/protractor.conf.js"
    - docker exec -i angular-master ng e2e --port 4202
  only:
    - master
  when: manual

build preprod:
  stage: build
  tags:
    - gpn-preprod-front
  script:
    - pwd | xargs /bin/bash /var/www/agent/front/01.sync.sh
    - /bin/bash /var/www/agent/front/02.npm_install.sh
    - /bin/bash /var/www/agent/front/03.ng_build.sh
    - /bin/bash /var/www/agent/front/04.change_girs.sh
    - exit 0
  only:
    - /^release-.*$/

build prod:
  stage: build
  tags:
    - gpn-prod-front
  script:
    - pwd | xargs /bin/bash /var/www/agent/front/01.sync.sh
    - /bin/bash /var/www/agent/front/02.npm_install.sh
    - /bin/bash /var/www/agent/front/03.ng_build.sh
    - /bin/bash /var/www/agent/front/04.change_girs.sh
    - exit 0
  only:
    - master
  when: manual
